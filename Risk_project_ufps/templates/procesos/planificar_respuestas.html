{% extends "procesos/plantilla_procesos.html" %}

{% block title %} RISKO | {{ proyecto.proyecto_nombre }} {% endblock %}




{% load static %}
{% block organigrama_up %}

{% endblock %}
{% block content %}
<div class="content-wrapper">
  <div class="container">
    <section class="content-header"  style="margin-top: 70px;">
      <h1>
        {% if proyecto %}
        {{ proyecto.proyecto_nombre }}
         <small>Planificar Respuestas</small>
        {% endif %}       
      </h1>
      <ol class="breadcrumb">
        <li><a href="#"><em class="fa fa-folder-open"></em> Procesos</a></li>
        <li class="active">Planificar respuestas</li>
      </ol>
      {% if mensaje %}
      <div class="callout callout-info">
        <h4>Registro Exitoso</h4>
        {{mensaje}}      
      </div>
      {% endif %}
      {% if mensaje_eliminar %}
      <div class="callout callout-danger">
        <h4>Borrado Exitoso</h4>
          {{mensaje_eliminar}}      
      </div>
      {% endif %}
      {% if mensaje_editar %}
      <div class="callout callout-warning">
        <h4>Actualización Exitosa</h4>
        {{mensaje_editar}}      
      </div>
      {% endif %}
    </section>
    <section class="content">

        <div class="box">
            <div class="box-group" id="accordion">
              <div class="panel box box-primary">
                <div class="box-header with-border">
                  <h4 class="box-title">
                    
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" style="color:#444444";>
                      <label ><strong>Informe plan de respuestas - Proyecto: {{ proyecto.proyecto_nombre }}  <em class="fa fa-sort-desc"></em></strong></label>
                      
                      
                    </a>
                  </h4>
                </div>
                <div id="collapseThree" class="panel-collapse collapse in">
                  <div class="box-body">
                      Este proceso permite desarrollar y establecer estrategias junto con sus recursos para las acciones a ejecutar cuando un riesgo logre materializarse a lo largo de todo el proyecto. A continuación podras descargar un informe del proceso planificar respuestas actualizado.
                      <br/>
                      <a class="btn btn-primary  pull-right" href="{% url 'generar_informe_planificar_respuesta' proyecto.proyecto_id %}">Generar informe</a>
                  </div>
                </div>
              </div>
           </div>
         </div>

      <div class="box box-primary">
        <div class="box-header with-border">
          <h3 class="box-title">
            <label data-toggle="tooltip" data-placement="top" title="En esta sección podra administrar toda la información de las acciones de respuesta asociadas a los riesgos del proyecto."><strong>Planificar respuestas - Proyecto: {{ proyecto.proyecto_nombre }}</strong></label>
          </h3>
        </div>
        <div class="box-body">
        	<table id="tabla_riesgos" class="table table-bordered table-striped">
                <caption></caption>
	            <thead>
	              <tr>
	              	<th scope="col"></th>
                      <th scope="col">Riesgo &nbsp<em class="fa fa-long-arrow-down"></em><em class="fa fa-long-arrow-up"></em></th>
                      <th scope="col"><label data-toggle="tooltip" data-placement="top" title="Evaluación asignada al riesgo.">Categorización &nbsp<em class="fa fa-long-arrow-down"></em><em class="fa fa-long-arrow-up"></em></label></th>
	                <th scope="col"><label data-toggle="tooltip" data-placement="top" title="Acciones de respuesta asociadas al riesgo.">Acciones </label></th>
                    <th scope="col"><label data-toggle="tooltip" data-placement="top" title="Tareas o actividades asociadas a las acciones.">Tareas </label></th>
                    <th scope="col"><label data-toggle="tooltip" data-placement="top" title="Recursos del proyecto asociados a las tareas.">Recursos</label></th>
                    <th scope="col"><label data-toggle="tooltip" data-placement="top" title="Suma de los recursos asignados a las tareas">Costos</label></th>
	              </tr>
	            </thead>
	            <tbody>
	             {% if lista_riesgos %}
	             {% for riesgo in lista_riesgos %}
	             <tr>
	             	<td></td>
	              <td>{{ riesgo.riesgo_nombre }}</td>
                <td class="riesgo_rango" id="riesgo_rango_{{ riesgo.riesgo_id }}" value="{{ riesgo.riesgo_id }}">{{ riesgo.riesgo_id }}</td>
	              <td> 
	                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal-respuestas" onclick="abrir_modal_respuestas('{{ riesgo.riesgo_id }}')"><em   class="fa fa-edit"></em></button>
	              </td>	             
                <td>
                  <button type="button" class="btn btn-success" data-toggle="modal" data-target="#modal-tareas" onclick="abrir_modal_tareas('{{ riesgo.riesgo_id }}')"><em   class="fa fa-edit"></em></button>
                </td>
                <td>
                  <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#modal-recursos" onclick="abrir_modal_recursos('{{ riesgo.riesgo_id }}')"><em   class="fa fa-edit"></em></button>
                </td>
                <td>
                  <button type="button" class="btn btn-default" data-toggle="modal" data-target="#modal-recursos" onclick="abrir_modal_costos('{{ riesgo.riesgo_id }}')"><em   class="fa fa-edit"></em></button>
                </td>                  
	            </tr>
	            {% endfor %}
	            {% else %}
	            <tr>
	              <td></td>
	              <td>No cuentas con riesgos registrados.</td>
	              <td></td> 
	              <td></td>
	            </tr>
	            {% endif %} 
	          </tbody>
	          <tfoot>
	            <tr>
	              <th scope="col"></th>
                  <th scope="col">Riesgo</th>
                  <th scope="col">Categorización</th>
                  <th scope="col">Acciones</th>
                  <th scope="col">Tareas</th>
                  <th scope="col"><label data-toggle="tooltip" data-placement="top" title="Corresponde a los recursos definidos dentro de este proyecto">Recursos</label></th>
                  <th scope="col"><label data-toggle="tooltip" data-placement="top" title="Suma de los recursos asignados a las tareas">Costos</label></th>
	            </tr>
	          </tfoot>
	        </table>
        </div>
      </div>


        <div class="box box-primary">
        <div class="box-header with-border">
          <h3 class="box-title">
            <label data-toggle="tooltip" data-placement="top" title="En esta sección podra encontrar información de la linea base de la gestión de riesgos del proyecto y como guardarla."><strong>Linea base de la administración de riesgos - Proyecto: {{ proyecto.proyecto_nombre }}</strong></label>
          </h3>
        </div>
        <div class="box-body" style="text-align: justify;">
          La linea base de la gestión de riesgos del proyecto es toda la información relacionada a la fase de planificación de los riesgos del proyecto, que va desde el proceso de planificar la gestión de riesgos hasta planificar respuestas. Al hacer clic se guardara un respaldo de esta información, la cual podra ser consultada en el historico ubicado en la parte superior del proceso planificar respuestas, o en controlar siempre y cuando se trate de la ultima linea base generada.
          <br/>          
          {% if proyecto.proyecto_fin_status %}
          <button class="btn btn-primary pull-right" onclick="crear_linea_base();" disabled="true">Guardar linea base</button>
          {% else %}
          <button class="btn btn-primary pull-right" onclick="crear_linea_base();">Guardar linea base</button>
          {% endif %}         
        </div>
      </div>
  </div>
</div>



<!-- /.modal tareas -->
<div class="modal fade" id="modal_tareas">
  <div class="modal-dialog  modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"><em class="fa fa-edit"></em> Tareas</h4>
        </div>
        <div class="modal-body">

         <div class="nav-tabs-custom">
          <!-- Tabs within a box -->
          <ul class="nav nav-tabs pull-right">
            <li class="active"><a href="#listado-tareas" data-toggle="tab"> Listado</a></li>
            <li ><a href="#nueva-tarea" data-toggle="tab">Nueva Tarea</a></li>            

          </ul>
          <div class="tab-content no-padding">
            <!-- Morris chart - Sales -->
            <div class="chart tab-pane active" id="listado-tareas" style="position: relative; height: 300px; overflow-y: scroll;">

             <div class="box-body">

               <table id="tabla_responsables" class="table table-bordered table-striped">
                   <caption></caption>
                <thead>
                  <tr>
                    <th scope="col">Nombre</th>
                    <th scope="col">Descripción</th>
                    <th scope="col">Fecha inicio</th>
                    <th scope="col">Fecha fin</th>
                    <th scope="col">Opciones</th>
                  </tr>
                </thead>
                <tbody id="tareas_riesgo">          
                </tbody>
                <tfoot>
                  <tr>
                    <th scope="col">Nombre</th>
                    <th scope="col">Descripción</th>
                    <th scope="col">Fecha inicio</th>
                    <th scope="col">Fecha fin</th>
                    <th scope="col">Opciones</th>
                  </tr>
                </tfoot>
              </table>
            </div>  

        </div>
        <div class="chart tab-pane" id="nueva-tarea" style="position: relative; height: 300px; overflow-y:auto;">
         <div class="box-body" id="tab_nueva_tarea">
          <div id="fechas_noti_content">
            
          </div>
          <form action="{% url 'nueva_tarea' proyecto.proyecto_id %}" method="post">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <div id="" class="form-group">
                    <label>Nombre Tarea</label>
                    <input type="text" class="form-control" id="tarea_nombre" maxlength="75" placeholder="Nombre tarea" name="tarea_nombre" required>                   
                  </div>
                  <div id="" class="form-group">
                    <label>Accion Asociada</label>                                        
                    <select class="form-control select2" id="respuesta_id" name="respuesta_id" required>    
                      <option >                      
                     </option>                      
                   </select>
                 </div>
                 <div id="" class="form-group">
                  <label>Fecha de Inicio</label>                                        
                  <div class="input-group date">
                    <div class="input-group-addon">
                      <em class="fa fa-calendar"></em>
                    </div>
                    <input type="date" class="form-control pull-right" name="tarea_fecha_inicio" required>
                  </div>
                </div>
                <input type="text" class="form-control" id="riesgo_id_ta" name="riesgo_id" style="visibility:hidden" />
              </div>            
            </div>
            <div class="col-md-6">
              <div id="" class="form-group">
                <label>Fecha Fin</label>
                <div class="input-group date">
                  <div class="input-group-addon">
                    <em class="fa fa-calendar"></em>
                  </div>
                  <input type="date" class="form-control pull-right" name="tarea_fecha_fin" required>
                </div>                  
              </div>
              <div class="form-group">
                <label>Descripción</label>
                <textarea class="form-control" rows="5" maxlength="3000" placeholder="Descripción de la tarea" name="tarea_descripcion"></textarea>
              </div>
              <div class="form-group">                  
              </div>
              {% if proyecto.proyecto_fin_status %}
              <button type="submit" class="btn btn-primary pull-right" disabled="true">Agregar</button>
              {% else %}
              <button type="submit" class="btn btn-primary pull-right">Agregar</button>
              {% endif %}  
              
              
            </div>
            <!-- /.col -->
          </div>
          <!-- /.row -->
        </form>
       </div><!-- /.box-body -->
       <div class="callout callout-warning" id="letrero_nueva_tarea" hidden="true"><h4>Notificación</h4>El riesgo no tiene acciones relacionadas. Debe agregar acciones antes de crear tareas.</div>
     </div>     
   </div>
 </div>
</div>
</div>
<!-- /.modal-content -->
</div>
<!-- /.modal-dialog -->
</div>


<!-- /.modal recursos -->
<div class="modal fade" id="modal_recursos">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"><em class="fa fa-edit"></em> Recursos</h4>
        </div>
        <div class="modal-body">

         <div class="nav-tabs-custom">
          <!-- Tabs within a box -->
          <ul class="nav nav-tabs pull-right">
            <li class="active"><a href="#listado-recursos" data-toggle="tab"> Listado</a></li>
            <li ><a href="#nuevo-recurso" data-toggle="tab">Nuevo Recurso</a></li>            

          </ul>
          <div class="tab-content no-padding">
            <!-- Morris chart - Sales -->
            <div class="chart tab-pane active" id="listado-recursos" style="position: relative; height: 300px; overflow-y: scroll;">

             <div class="box-body">

               <table id="tabla_responsables" class="table table-bordered table-striped">
                   <caption></caption>
                <thead>
                  <tr>
                    <th scope="col">Tarea</th>
                    <th scope="col">Recursos</th>
                    <th scope="col">Cantidad</th>
                    <th scope="col">Opciones</th>
                  </tr>
                </thead>
                <tbody id="listado_recursos">         
                  <tr>
                    <td>No cuentas con recursos asociados a este riesgo.</td>
                    <td></td>
                  </tr>                  
                </tbody>
                <tfoot>
                  <tr>
                    <th scope="col">Tarea</th>
                    <th scope="col">Recursos</th>
                    <th scope="col">Cantidad</th>
                    <th scope="col">Opciones</th>
                  </tr>
                </tfoot>
              </table>
            </div>  

        </div>
        <div class="chart tab-pane" id="nuevo-recurso" style="position: relative; height: 300px;">
         <div class="box-body" id="recurso_form_nuevo">
          <form action="{% url 'nuevo_recurso_tarea' proyecto.proyecto_id %}" method="post">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <div id="" class="form-group">
                    <label>Recurso</label>
                    {% if lista_recursos %}
                    
                    <select class="form-control select2"  id="recurso_id" name="recurso_id">
                    {% for recurso in lista_recursos %}    
                      <option value="{{ recurso.recurso_id }}">
                       {{ recurso.recurso_nombre }}
                     </option>
                      {% endfor %}                      
                   </select>                   
                  {% else %}
                    <p>No cuentas con recursos asociados al proyecto.</p>                    
                  {% endif %}                 
                  </div>

                 <div class="form-group">
                <label data-toggle="tooltip" data-placement="top" title="Ingrese la cantidad unitaria o de horas por semana requeridas del recurso.">Cantidad (Unitaria-Horas/Semana)</label>

                <input type="number" min="1" class="form-control" id="recurso_cantidad" placeholder="Cantidad del recurso asignado..." name="recurso_cantidad">
              </div>

               </div>            
             </div>
             <div class="col-md-6">

              

               <div id="" class="form-group">
                    <label>Tarea Asociada</label>                                        
                    <select class="form-control select2" id="tarea_id" name="tarea_id">                       
                   </select>
                 </div>


              <input type="text" class="form-control" id="riesgo_id_re" name="riesgo_id" style="visibility:hidden">
              <!-- / input para pasar el id del riesgo al asociarle la actividad -->
              {% if proyecto.proyecto_fin_status %}
              <button type="submit" class="btn btn-primary pull-right" disabled="true">Agregar</button>
              {% else %}
              <button type="submit" class="btn btn-primary pull-right">Agregar</button>
              {% endif %} 
              
            </div>
            <!-- /.col -->
          </div>
          <!-- /.row -->
        </form>
       </div><!-- /.box-body -->
       <div class="callout callout-warning" id="recurso_letrero_uno" >
        <h4>Notificación</h4>
        Este proyecto no cuenta con recursos para poder asignar. <strong>Registre sus recursos <a href="{% url 'recursos' proyecto.proyecto_id %}">aqui</a></strong>
      </div>
      <div class="callout callout-warning" id="recurso_letrero_dos" hidden="true">
        <h4>Notificación</h4>
        Este riesgo no cuenta con tareas para poder asignar recursos.       
      </div>
     </div>     
   </div>
 </div>
</div>
</div>
<!-- /.modal-content -->
</div>
<!-- /.modal-dialog -->
</div>



<!-- /modal respuestas -->
<div class="modal fade" id="modal_respuestas">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"><em class="fa fa-edit"></em> Acciones de respuesta</h4>
        </div>
        <div class="modal-body">

         <div class="nav-tabs-custom">
          <!-- Tabs within a box -->
          <ul class="nav nav-tabs pull-right">
            <li class="active"><a href="#listado_respuestas" data-toggle="tab"> Listado</a></li>         <li ><a href="#respuesta_sugerida" data-toggle="tab">Agregar Respuesta Sugerida</a></li> 
            <li ><a href="#nueva_respuesta" data-toggle="tab">Nueva Respuesta</a></li> 
            

          </ul>
          <div class="tab-content no-padding">
            <!-- Morris chart - Sales -->
            <div class="chart tab-pane active" id="listado_respuestas" style="position: relative; height: 300px; overflow-y: scroll; overflow-x: scroll;">

             <div class="box-body">

              <table id="tabla2" class="table table-bordered table-striped">
                  <caption></caption>
                <thead>
                  <tr>
                    <th scope="col">Respuesta</th>
                    <th scope="col">Descripción</th>
                    <th scope="col">Tipo Respuesta</th>
                    <th scope="col">Opciones</th>
                  </tr>
                </thead>
                <tbody id="respuestas_body">                 
                  <tr>
                    <td>No cuentas con respuestas asociadas a este riesgo.</td>
                    <td></td>
                    <td></td> 
                    <td></td>                
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <th scope="col">Respuesta</th>
                    <th scope="col">Descripción</th>
                    <th scope="col">Tipo Respuesta</th>
                    <th scope="col">Opciones</th>
                  </tr>
                </tfoot>
              </table>
            </div>  

          </div>
          <div class="chart tab-pane" id="respuesta_sugerida" style="position: relative; height: 300px; overflow-y: scroll;">

           <div class="box-body">
            <form action="{% url 'asociar_respuesta_sugeridas' proyecto.proyecto_id %}" method="post">
              {% csrf_token %}
              <table id="tabla2" class="table table-bordered table-striped">
                  <caption></caption>
              <thead>
                <tr>
                  <th scope="col"></th>
                  <th scope="col">Respuesta</th>
                  <th scope="col">Descripción</th>
                </tr>
              </thead>
              <tbody id="respuestas_sugeridas_body">                 
                <tr>
                  <td>No cuentas con respuestas sugeridas para este riesgo.</td>
                  <td></td> 
                  <td></td>                
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <th scope="col"></th>
                  <th scope="col">Respuesta</th>
                  <th scope="col">Descripción</th>
                </tr>
              </tfoot>
              </table>
              <input type="text" name="riesgo_id_rta" id="riesgo_id_rta" hidden="true"/>
               <div class="form-group">
                <div class="row no-print">
                  <div class="col-md-11">
                    {% if proyecto.proyecto_fin_status %}                    
                    <button type="submit" class="btn btn-success pull-right" disabled="true"><em class="fa fa-plus"></em>Agregar</button>
                    {% else %}                    
                    <button type="submit" class="btn btn-success pull-right"><em class="fa fa-plus"></em>Agregar</button>
                    {% endif %}  
   
                  </div>
                </div>
                <br>
              </div>
            </form>
          </div>  
         
        </div>
        <div class="chart tab-pane" id="nueva_respuesta" style="position: relative; height: 300px;">
         <div class="box-body">
          <form action="{% url 'nueva_respuesta_planificar' proyecto.proyecto_id %}" method="post">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <div class="form-group">
                    <label >Nombre</label>
                    <input type="text" class="form-control" id="respuesta_nombre" placeholder="Nombre respuesta" maxlength="44" name="respuesta_nombre">
                  </div>
                </div>
                <div class="form-group">
                  <label>Tipo de Acción</label>
                  <select class="form-control select2" id="responsable_id" name="tipo_respuesta">
                    <optgroup label="Riesgo">
                      <option value="Mitigar">
                       Mitigar
                     </option>
                     <option value="Evitar">
                       Evitar
                     </option>
                     <option value="Transferir">
                       Transferir
                     </option>
                     <option value="Aceptar">
                       Aceptar
                     </option>
                   </optgroup> 
                   <optgroup label="Oportunidades">
                    <option value="Explotar">
                     Explotar
                   </option>
                   <option value="Compartir">
                     Compartir
                   </option>
                   <option value="Mejorar">
                     Mejorar
                   </option>
                   <option value="Aceptar">
                     Aceptar
                   </option>
                 </optgroup>                  
               </select>
             </div>
             <!-- / input para pasar el id del riesgo al asociarle la respuesta -->
             <input type="text" class="form-control" id="riesgo_id_r" name="riesgo_id" style="visibility:hidden">
           </div>            
              <div class="col-md-6">
                <div class="form-group">
                  <label>Descripción</label>
                  <textarea class="form-control" rows="5" maxlength="3000" placeholder="Descripción de la accion" name="respuesta_descripcion"></textarea>
                </div>
                <div class="box-footer">
                  {% if proyecto.proyecto_fin_status %}
                  <button type="submit" class="btn btn-primary pull-right" disabled="´true">Registrar</button>
                  {% else %}
                  <button type="submit" class="btn btn-primary pull-right">Registrar</button>
                  {% endif %}                    
                </div>
              </div>
              <!-- /.col -->
            </div>
            <!-- /.row -->
          </form>
        </div><!-- /.box-body -->
      </div>     
    </div>
  </div>
</div>
</div>
<!-- /.modal-content -->
</div>
<!-- /.modal-dialog -->
</div>
<!-- /modal respuestas -->

 <!-- /.modal-editar respuesta -->
 <div class="modal fade" id="modal_editar_respuesta"> 
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Editar Respuesta</h4>
        </div>
        <div class="box-body">
          {% if proyecto %}
          <form action="{% url 'editar_respuesta_planificar' proyecto.proyecto_id %}" method="post">
           {% else %}  
           <form action="#" method="post">
            {% endif %}
            {% csrf_token %}
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <div class="form-group">
                    <label >Nombre</label>
                    <input type="text" class="form-control" id="respuesta_nombre_e" maxlength="44" placeholder="Nombre respuesta" name="respuesta_nombre" required>
                  </div>
                </div>
                <div class="form-group">
                  <label>Tipo de Acción</label>
                  <select class="form-control select2" id="responsable_id_e" name="tipo_respuesta">
                    <optgroup label="Riesgo">
                      <option value="Mitigar">
                       Mitigar
                     </option>
                     <option value="Evitar">
                       Evitar
                     </option>
                     <option value="Transferir">
                       Transferir
                     </option>
                     <option value="Aceptar">
                       Aceptar
                     </option>
                   </optgroup> 
                   <optgroup label="Oportunidades">
                    <option value="Explotar">
                     Explotar
                   </option>
                   <option value="Compartir">
                     Compartir
                   </option>
                   <option value="Mejorar">
                     Mejorar
                   </option>
                   <option value="Aceptar">
                     Aceptar
                   </option>
                 </optgroup>                  
               </select>
                </div>
                <!-- / input para pasar el id del riesgo al asociarle la respuesta -->
                <input type="text" class="form-control" id="respuesta_id_e" name="respuesta_id" style="visibility: hidden;">
                 <input type="text" class="form-control" id="riesgo_id_e" name="riesgo_id" style="visibility: hidden;">
              </div>            
              <div class="col-md-6">
                <div class="form-group">
                  <label>Descripción</label>
                  <textarea class="form-control" rows="5" maxlength="3000" id="respuesta_descripcion_e" placeholder="Descripción de la accion" name="respuesta_descripcion" required></textarea>
                </div>
                <div class="box-footer">                 
                  <button type="submit" class="btn btn-primary pull-right">Registrar</button>
                </div>
              </div>
              <!-- /.col -->
            </div>
            <!-- /.row -->
          </form>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>

<!-- modal eliminar respuesta -->
  <div class="modal modal-danger fade" id="modal_eliminar_respuesta" >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title"> Eliminar </h4>
          </div>
          <form  action="{% url 'desasociar_respuesta_riesgo' proyecto.proyecto_id %}" method="post">
            {% csrf_token %}
          <div class="modal-body">
            <p id="contenido_modal_respuesta">&hellip;</p>
            <h2 id="nombre_modal_respuesta"></h2>
            <input type="text" class="form-control" id="respuesta_id_eliminar" name="respuesta_id_eliminar" style="visibility: hidden;" />         
            <input type="text" class="form-control" id="riesgo_id_eliminar" name="riesgo_id_eliminar" style="visibility: hidden;" />   
            <p>Tenga en cuenta lo siguiente:</p>
            <ul><li>Al eliminar esta acción de respuesta, tambien se eliminaran las tareas y recursos asignados a esta acción.</li></ul>  
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline pull-left" data-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-outline">Eliminar</button>
          </div>
          </form>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
<!-- /. modal eliminar respuesta -->






<!-- /.modal-eliminar tarea -->

  <div class="modal modal-danger fade" id="modal_eliminar_tarea" >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title"> Eliminar </h4>
          </div>
          <form action="{% url 'eliminar_tarea' proyecto.proyecto_id %}" method="post">
            {% csrf_token %}
          <div class="modal-body">
            <p id="contenido_modal_tarea">&hellip;</p>
            <h2 id="nombre_tarea"></h2>
            <input type="text" class="form-control" id="tarea_id_e" name="tarea_id" style="visibility:hidden">            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline pull-left" data-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-outline">Eliminar</button>
          </div>
          </form>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
<!-- /.modal-eliminar -->

  <!-- /.modal-editar tarea -->
 <div class="modal fade" id="modal-editar-tarea"> 
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Editar Tarea</h4>
          </div>
          <div class="box-body">
          {% if proyecto %}
          <form action="{% url 'editar_tarea' proyecto.proyecto_id %}" method="post">
          {% else %}  
          <form action="#" method="post">
            {% endif %}

            {% csrf_token %}
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label >Nombre </label>
                  <input type="text" class="form-control" id="tarea_nombre_e" maxlength="75" name="tarea_nombre">
                  <div id="" class="form-group">
                    <label>Fecha Inicio</label>
                    <div class="input-group date">
                      <div class="input-group-addon">
                        <em class="fa fa-calendar"></em>
                      </div>
                      <input type="date" class="form-control pull-right" name="tarea_fecha_inicio" id="tarea_fecha_inicio_ed">
                    </div>                  
                  </div>
                </div>
                <input type="text" class="form-control" id="tarea_id_ed" name="tarea_id" style="visibility:hidden">               
              </div>
              <!-- /.col -->
              <div class="col-md-6">
                <div id="" class="form-group">
                  <label>Fecha Fin</label>
                  <div class="input-group date">
                    <div class="input-group-addon">
                      <em class="fa fa-calendar"></em>
                    </div>
                    <input type="date" class="form-control pull-right" name="tarea_fecha_fin" id="tarea_fecha_fin_ed">
                  </div>                  
                </div>              
                <div class="form-group">
                  <label>Descripción</label>
                  <textarea class="form-control" rows="3"  maxlength="3000" id="descripcion_tarea_e" name="descripcion_tarea"></textarea>
                </div>
              </div>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary pull-left" data-dismiss="modal">Cerrar</button>
              <button type="submit" class="btn btn-primary pull-right">Actualizar</button>
            </div>
            <!-- /.row -->
          </form>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>

  <!-- /.modal-eliminar tarea -->

  <div class="modal modal-danger fade" id="modal_desvincular_recurso" >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title"> Eliminar </h4>
          </div>
          <form action="{% url 'desvincular_recurso_tarea' proyecto.proyecto_id %}" method="post">
            {% csrf_token %}
          <div class="modal-body">
            <p id="contenido_modal_recurso">&hellip;</p>
            <h2 id="nombre_recurso"></h2>
            <input type="text" class="form-control" id="recurso_id_e" name="recurso_id" style="visibility: hidden;" >
            <input type="text" class="form-control" id="tarea_id_e_r" name="tarea_id" style="visibility: hidden; ">            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline pull-left" data-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-outline">Eliminar</button>
          </div>
          </form>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
<!-- /.modal-eliminar -->


<!-- /.modal costos -->

<div class="modal fade" id="modal-costos"> 
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Costos</h4>
      </div>
      <div class="box-body" >
        <div class="row justify-content-md-center">
          <div class="col col-lg-1"></div>
          <div class="col-md-10">
            <table class="table table-striped">
                <caption></caption>
              <thead>
              <tr>
                <th scope="col"></th>
                <th scope="col">Accion</th>
                <th scope="col">Tarea</th>
                <th scope="col">Recurso</th>
                <th scope="col">Cantidad</th>
                <th scope="col">Costo</th>
              </tr>
              </thead>
              <tbody id="costos_body">
              </tbody>
              <tfoot>
              <tr>
                <th scope="col"></th>
                <th scope="col"></th>
                <th scope="col"></th>
                <th scope="col"></th>
                <th scope="col">Costo del riesgo</th>
                <th scope="col" id="costo_riesgo"></th>
              </tr>
              <tr>
                <th scope="col"></th>
                <th scope="col"></th>
                <th scope="col"></th>
                <th scope="col"></th>
                <th scope="col">Total del proyecto</th>
                <th scope="col" id="costo_proyecto"></th>
              </tr>
              </tfoot>
            </table>
          </div>
          <div class="col col-lg-1"></div>
        </div>   
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary pull-right" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>   
</div>

<!-- /.modal costos -->
<div class="modal modal-info fade" id="modal-info" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span></button>
        <h4 class="modal-title">Advertencia</h4>
      </div>
      <div class="modal-body">
        <p>No puede crear una "Linea Base de la Administración de Riesgos" hasta que haya definido al menos una tarea</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline pull-left" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>

{% endblock %}
{% block organigrama_down %}
<!-- DataTables -->
<script src="{% static 'risk_project/bower_components/datatables.net/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'risk_project/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>
<script src="{% static 'risk_project/plugins/sweetalert/sweetalert.js' %}"></script>
<script type="text/javascript">
  //////////////////////////////////////////
  //  Variables globales
  /////////////////////////////////////////

  /*
   *  Corresponde a todo el conjunto de riesgos del proyecto 
   *  junto con sus respuestas asociadas  
   */
  var respuestas_riesgo = JSON.parse("{{respuestas_riesgo|escapejs}}");  
  //console.log(respuestas_riesgo);

  var lista_tareas = JSON.parse("{{lista_tareas|escapejs}}");  
  //console.log(lista_tareas);

  //Contiene los riesgos junto con sus respuestas sugeridas
  var respuestas_sugeridas = JSON.parse("{{respuestas_sugeridas|escapejs}}");
  //console.log("respuestas");
  //console.log(respuestas_sugeridas);

  var actividades_by_riesgos = JSON.parse("{{actividades_by_riesgos|escapejs}}");
  //console.log("actividades_by_riesgos", actividades_by_riesgos);
  //Contiene la cantidad de recursos que tiene el proyecto.
  //Con esta variable puedo controlar el tipo de mensaje
  //en el modal de nuevo recursos
  var cantidad_recursos = parseInt("{{lista_recursos|length}}", 10);

  
  //Son los colores de la evaluacion
  var rangos_riesgos = JSON.parse("{{rangos|escapejs}}");  
  //console.log(rangos_riesgos);

  var riesgos_evaluados = JSON.parse("{{riesgos_evaluados|escapejs}}");  
  //console.log("riesgos_evaluados", riesgos_evaluados);

  var valores = JSON.parse("{{valores|escapejs}}");
  //console.log(valores);

  function pintar_rangos_riesgos() {
    let riesgos = document.getElementsByClassName("riesgo_rango");
    for (let i = 0; i < riesgos.length; i++) {  
      riesgo_id = riesgos[i].innerText;
      riesgos[i].innerHTML ="";
      let key = 'riesgo_' + riesgo_id;
      if(riesgos_evaluados.hasOwnProperty(key)){
        impacto_id = riesgos_evaluados[key]['impacto_id'];
        probabilidad_id = riesgos_evaluados[key]['propabilidad_id'];
        impacto_escala = get_escala_by_impacto_id(impacto_id);
        probabilidad_escala = get_escala_by_probabilidad_id(probabilidad_id);
        evaluacion = impacto_escala * probabilidad_escala;
        rango = get_rango(evaluacion);        
        let temp = '<small class="label" style="background-color:'+rango[0]+';"></i>'+rango[1]+'</small>';
        let gg = $.parseHTML(temp) 
        $("#riesgo_rango_"+riesgo_id).append(gg);
      }
    }
  }

  function get_escala_by_impacto_id(impacto_id) {
    impactos = valores['impactos'];
    escala = 0;
    for (let i = 0; i < impactos.length; i++) {
      if(impactos[i]['id'] == impacto_id){
        escala = impactos[i]['escala'];
        break;
      }
    }
    return escala;
  }

  function get_escala_by_probabilidad_id(probabilidad_id) {
    probabilidades = valores['probabilidades'];
    escala = 0;
    for (let i = 0; i < probabilidades.length; i++) {
      if(probabilidades[i]['id'] == probabilidad_id){
        escala = probabilidades[i]['escala'];
        break;
      }
    }
    return escala;
  }

  function get_rango(valor){
    color = 0;
    nombre = "";
    n = rangos_riesgos.length;
    for (let i = 0; i < n - 1; i++) {
      let rango = rangos_riesgos[i]["rango"];
      if(valor >= rango[0] && valor <= rango[1] ){      
        color = rangos_riesgos[i]["color"];
        nombre = rangos_riesgos[i]["nombre"];
        break;
      }
    }
    if(color == 0){
      color = rangos_riesgos[n-1]["color"];
      nombre = rangos_riesgos[n-1]["nombre"];      
    }
    return [color, nombre];
  }


	$(document).ready(function() {
    pintar_rangos_riesgos();
	    var t = $("#tabla_riesgos").DataTable({
	    	"language": {
	         "sProcessing":    "Procesando...",
	         "sLengthMenu":    "Mostrar _MENU_ registros",
	         "sZeroRecords":   "No se encontraron resultados",
	         "sEmptyTable":    "Ningún dato disponible en esta tabla",
	         "sInfo":          "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
	         "sInfoEmpty":     "Mostrando registros del 0 al 0 de un total de 0 registros",
	         "sInfoFiltered":  "(filtrado de un total de _MAX_ registros)",
	         "sInfoPostFix":   "",
	         "sSearch":        "Buscar:",
	         "sUrl":           "",
	         "sInfoThousands":  ",",
	         "sLoadingRecords": "Cargando...",
	         "oPaginate": {
	             "sFirst":    "Primero",
	             "sLast":    "Último",
	             "sNext":    "Siguiente",
	             "sPrevious": "Anterior"
	         },
	         "oAria": {
	             "sSortAscending":  ": Activar para ordenar la columna de manera ascendente",
	             "sSortDescending": ": Activar para ordenar la columna de manera descendente"
	         }
	    	}	    	
		}); 
	 
	    t.on( 'order.dt search.dt', function () {
	        t.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
	            cell.innerHTML = i+1;
	        } );
	    } ).draw();

     /*
      Este segmento permite activar los subtitulos para todos los elementos del documento
    */    
    $('[data-toggle="tooltip"]').tooltip();
    
	});
////////////////////////////////////////////
// Funciones del modal acciones de respuesta
////////////////////////////////////////////


  function abrir_modal_respuestas(id_riesgo) { 
    construir_listado_respuesta(id_riesgo);  
    construir_respuestas_sugeridas(id_riesgo);
    $("#riesgo_id_rta").val(id_riesgo);
    $("#modal_respuestas").modal('show');
    var input_id = document.getElementById("riesgo_id_r");
    input_id.value = id_riesgo;  
  };

  function abrir_modal_eliminar_respuesta(riesgo_id, respuesta_id, nombre) {        
    $("#modal_eliminar_respuesta").modal('show');
    document.getElementById("contenido_modal_respuesta").innerHTML = "Estas seguro que desea eliminar este la acción de respuesta:";
    document.getElementById("nombre_modal_respuesta").innerHTML = " "+nombre;
    $("#respuesta_id_eliminar").val(respuesta_id);
    $("#riesgo_id_eliminar").val(riesgo_id);    
  }

   function abrir_modal_editar_respuesta(riesgo_id, respuesta_id, nombre, fecha, descripcion, respuesta_tipo) {        
      $("#modal_editar_respuesta").modal('show');
     $("#respuesta_nombre_e").val(nombre);
     $("#respuesta_id_e").val(respuesta_id);
     $("#riesgo_id_e").val(riesgo_id);
     $("#respuesta_fecha_inicio_e").val(fecha);
     $("#respuesta_descripcion_e").val(descripcion);
     $("#responsable_id_e").val(respuesta_tipo);
  }

  function abrir_modal_costos(riesgo_id) {
    let costos_body = document.getElementById("costos_body");
    costos_body.innerHTML = "";
    let key = 'riesgo_'+riesgo_id;
    let total = 0;  
    let total_proyecto = get_costo_total_proyecto();
    if(lista_tareas.hasOwnProperty(key)){   
      let tareas = lista_tareas[key];
      let cont = 1;      
      for (let i = 0; i < tareas.length; i++) {
        let tarea = tareas[i];
        if(tarea['recursos'].length > 0){
          let respuesta = get_respuesta_by_riesgo_has_respuesta(riesgo_id, tareas[i]['riesgo_has_respuesta']);
          let recursos_nombres = "";
          let recursos_costos = "";
          let recursos_cantidad = "";
          for (let j = 0; j < tarea['recursos'].length; j++) {
            recursos_nombres += tarea['recursos'][j]['recurso_nombre'] + '<br>';
            let c = tarea['recursos'][j]['cantidad'] * tarea['recursos'][j]['recurso_costo'];
            recursos_costos += tarea['recursos'][j]['recurso_costo'] + '<br>';
            recursos_cantidad += tarea['recursos'][j]['cantidad'] + '<br>';
            total += c;
          }
          let temp = '<tr><td>'+cont+'</td><td>'+respuesta['respuesta_nombre']+'</td><td>'+tareas[i]['tarea_nombre']+'</td><td>'+recursos_nombres+'</td><td>'+recursos_cantidad+'</td><td>'+recursos_costos+'</td></tr>'
          let gg = $.parseHTML(temp) 
          $(costos_body).append(gg);
          $("#costo_riesgo").text("$"+total);
          $("#costo_proyecto").text("$"+total_proyecto);
        }
      }
    }else{
      let tempr = '<tr><td></td><td>No existen costos para mostrar</td><td></td><td></td><td></td><td></td></tr>'
      let ggt = $.parseHTML(tempr) 
      $(costos_body).append(ggt); 
      $("#costo_riesgo").text("$0");
      $("#costo_proyecto").text("$"+total_proyecto);
    }        
    $("#modal-costos").modal('show');  
  }

  function get_costo_total_proyecto() {
    let aux = 0;
    //perdoname Diosito(Object.keys(an_obj)
    Object.keys(lista_tareas).forEach(function(key) {
      let riesgo = lista_tareas[key];
      riesgo.forEach(function(tarea) {
        tarea['recursos'].forEach(function(recurso) {
          aux += recurso['recurso_costo'] * recurso['cantidad'];
        });
      });
    });
    return aux;
  } 

  function get_respuesta_by_riesgo_has_respuesta(riesgo_id, riesgo_has_respuesta){      
    let key = 'riesgo_'+riesgo_id;   
    if(respuestas_riesgo.hasOwnProperty(key)){   
      let respuestas = respuestas_riesgo[key];      
      for (let i = 0; i < respuestas.length; i++) {
        if( respuestas[i]['riesgo_has_respuesta'] == riesgo_has_respuesta ){
          return respuestas[i];
        } 
      }
    }
    return null;
  }


  function construir_listado_respuesta(id_riesgo) {
    let respuestas_body = document.getElementById('respuestas_body');
    respuestas_body.innerHTML = "";
    let key = 'riesgo_'+id_riesgo;
   
    if(respuestas_riesgo.hasOwnProperty(key)){   
      let respuestas = respuestas_riesgo[key];
      for (var i = 0; i < respuestas.length; i++) {
        let tr = document.createElement("tr");   
        let td_nombre = document.createElement("td");
        let td_descripcion = document.createElement("td");
        let td_tipo = document.createElement("td");
        let td_acciones = document.createElement("td");
        td_nombre.appendChild(document.createTextNode(respuestas[i]["respuesta_nombre"]));
        td_descripcion.appendChild(document.createTextNode(respuestas[i]["respuesta_descripcion"]));
        td_tipo.appendChild(document.createTextNode(respuestas[i]["tipo_respuesta"]))
        let boton = document.createElement("button");        
        boton.setAttribute("type", "button");        
        boton.setAttribute("class", "btn btn-danger");        
        boton.setAttribute("data-toggle", "#modal_eliminar_respuesta");        
        boton.setAttribute("onclick", "abrir_modal_eliminar_respuesta('"+id_riesgo+"','"+respuestas[i]["respuesta_id"]+"', '"+respuestas[i]["respuesta_nombre"]+"')" );        
        boton.setAttribute("data-target", "#modal_eliminar_respuesta");
         let mi_icon = document.createElement("i");
        mi_icon.setAttribute("class", "fa fa-trash-o danger")
        boton.appendChild(mi_icon);

        let botonE = document.createElement("button");
        botonE.setAttribute("type", "button");
        botonE.setAttribute("class", "btn btn-default");
        botonE.setAttribute("data-toggle", "#modal_editar_respuesta");
        botonE.setAttribute("onclick", "abrir_modal_editar_respuesta('"+id_riesgo+"','"+respuestas[i]["respuesta_id"]+"', '"+respuestas[i]["respuesta_nombre"]+"','"+respuestas[i]["fecha_inicio_respuesta"]+"', '"+respuestas[i]["respuesta_descripcion"]+"', '"+respuestas[i]["tipo_respuesta"]+"')");
        botonE.setAttribute("data-target", "#modal_editar_respuesta");
        let mi_iconE = document.createElement("i");
        mi_iconE.setAttribute("class", "fa fa-edit")
        botonE.appendChild(mi_iconE);

        if("{{proyecto.proyecto_fin_status}}"==1){
          boton.setAttribute("disabled", "true");
          botonE.setAttribute("disabled", "true");
        }

        td_acciones.appendChild(botonE);
        td_acciones.appendChild(boton);        
        tr.appendChild(td_nombre);
        tr.appendChild(td_descripcion);
        tr.appendChild(td_tipo);
        tr.appendChild(td_acciones);  
        respuestas_body.appendChild(tr);
      }
    }else{
      let tr = document.createElement("tr");   
      let td_nombre = document.createElement("td");
      let td_descripcion = document.createElement("td");
      let td_acciones = document.createElement("td");
      td_nombre.appendChild(document.createTextNode("No cuentas con respuestas asociadas a este riesgo.")); 
      tr.appendChild(td_nombre);
      tr.appendChild(td_descripcion);
      tr.appendChild(td_acciones);    
      respuestas_body.appendChild(tr);  
    }  
  }

  function construir_respuestas_sugeridas(id_riesgo){
    let respuestas_body = document.getElementById('respuestas_sugeridas_body');
    respuestas_body.innerHTML = "";
    let key = 'riesgo_'+id_riesgo;
   
    if(respuestas_sugeridas.hasOwnProperty(key)){   
      let respuestas = respuestas_sugeridas[key];
      if(respuestas.length > 0){              
        for (var i = 0; i < respuestas.length; i++) {
          if (validar_nombre_respuesta_repetida(id_riesgo, respuestas[i]["respuesta_nombre"]) == false){        
            let tr = document.createElement("tr");   
            let td_input = document.createElement("td");
            let td_nombre = document.createElement("td");
            let td_descripcion = document.createElement("td");

            let input = document.createElement("input");
            input.setAttribute("type", "checkbox");
            input.setAttribute("value", respuestas[i]["respuesta_id"]);
            input.setAttribute("name", "respuesta_sugerida_"+respuestas[i]["respuesta_id"]);
            td_input.appendChild(input);
            td_nombre.appendChild(document.createTextNode(respuestas[i]["respuesta_nombre"]));
            td_descripcion.appendChild(document.createTextNode(respuestas[i]["respuesta_descripcion"]));      
                     
            tr.appendChild(td_input);
            tr.appendChild(td_nombre);
            tr.appendChild(td_descripcion);
      
            respuestas_body.appendChild(tr);
          }
        }
      }else{
        let tr = document.createElement("tr");   
        let td_acciones = document.createElement("td");
        let td_nombre = document.createElement("td");
        let td_descripcion = document.createElement("td");      
        td_nombre.appendChild(document.createTextNode("No cuentas con respuestas asociadas a este riesgo.")); 
        tr.appendChild(td_acciones);   
        tr.appendChild(td_nombre);
        tr.appendChild(td_descripcion);   
        respuestas_body.appendChild(tr);  
      }
    }else{
      let tr = document.createElement("tr");   
      let td_acciones = document.createElement("td");
      let td_nombre = document.createElement("td");
      let td_descripcion = document.createElement("td");      
      td_nombre.appendChild(document.createTextNode("No cuentas con respuestas asociadas a este riesgo.")); 
      tr.appendChild(td_acciones);   
      tr.appendChild(td_nombre);
      tr.appendChild(td_descripcion);   
      respuestas_body.appendChild(tr);  
    }  
  }

  /*
   * El objetivo es verificar que no aparezcan respuestas sugeridas con el mismo nombre
   * de respuestas ya asignadas. Esto no es un error, simplemente es un efecto colateral de 
   * duplicar las respuestas para que queden independientes
   */
  function validar_nombre_respuesta_repetida(id_riesgo, respuesta_nombre){
    let flag = false;
    let key = 'riesgo_'+id_riesgo;
    if(respuestas_riesgo.hasOwnProperty(key)){   
      let respuestas = respuestas_riesgo[key];
      for (let i = 0; i < respuestas.length; i++) {
        if(respuestas[i]["respuesta_nombre"] == respuesta_nombre){
          flag = true;
          break;
        }
      }
    }
    return flag;
  }
////////////////////////////////////////////////
// ./Funciones del modal acciones de respuesta
////////////////////////////////////////////////

//////////////////////////////////////////////
// Funciones para el modal de tareas
//////////////////////////////////////////////

  function abrir_modal_tareas(id_riesgo) {                
    construir_select_respuesta_for_tareas(id_riesgo);
    construir_listado_tareas(id_riesgo);
    var input_id = document.getElementById("riesgo_id_ta");
    input_id.value = id_riesgo;
    cambiar_fechas();
    $("#modal_tareas").modal('show');
    

};


  function cambiar_fechas() {
    let riesgo_id = document.getElementById("riesgo_id_ta").value;    
    let fechas_noti_content = document.getElementById("fechas_noti_content");
    fechas_noti_content.innerHTML = '';
    /*var li = document.createElement('li');
    li.append(document.createTextNode("Fecha de planeada del riesgo: " +get_fecha_by_riesgo_id(riesgo_id)));
    ul.append(li);*/
    if(actividades_by_riesgos.hasOwnProperty("riesgo_"+riesgo_id)){
      let str = '<div class="alert alert-info alert-dismissible" id="fechas_noti_content"><h4><i class="icon fa fa-info"></i> Atencion!</h4>Tenga en cuenta las siguientes fechas:<div id="fechas_noti"></div></div>';
      let html = $.parseHTML(str);
      $(fechas_noti_content).append(html);
      let fechas_noti = document.getElementById("fechas_noti");
      var ul = document.createElement('ul');
      let riesgo = actividades_by_riesgos["riesgo_"+riesgo_id];
      //console.log(riesgo);
      for (var i = 0; i < riesgo.length; i++) {
        var li_2 = document.createElement('li');
        li_2.append(document.createTextNode("Fecha de planeada de la actividad: " +riesgo[i]['actividad_nombre']));
        var ul_aux = document.createElement('ul');
        var li_a = document.createElement('li');
        li_a.append("Fecha inicio: "+riesgo[i]['actividad_fecha_inicio']+" - "+"Fecha fin: "+riesgo[i]['actividad_fecha_fin']);
        ul_aux.append(li_a);
        li_2.append(ul_aux);
        ul.append(li_2);
        fechas_noti.append(ul);
      }
    }
  }

 /*function get_fecha_by_riesgo_id(riesgo_id) {
    let key = "riesgo_"+riesgo_id;
    if(riesgos_evaluados.hasOwnProperty(key)){
      return riesgos_evaluados[key]['fecha_manifestacion'];
    }
 }*/

  function construir_select_respuesta_for_tareas(id_riesgo){  
    let tab_nueva_tarea = document.getElementById('tab_nueva_tarea');
      tab_nueva_tarea.removeAttribute("hidden");
    let letrero_nueva_tarea = document.getElementById('letrero_nueva_tarea');
      letrero_nueva_tarea.setAttribute("hidden", "true");  
    let respuestas_body = document.getElementById('respuesta_id');
    respuestas_body.innerHTML = "";
    let key = 'riesgo_'+id_riesgo;
   
    if(respuestas_riesgo.hasOwnProperty(key)){   
      let respuestas = respuestas_riesgo[key];
      for (var i = 0; i < respuestas.length; i++) {
        let opcion = document.createElement("option");
        opcion.appendChild(document.createTextNode(respuestas[i]["respuesta_nombre"]));
        opcion.setAttribute("value", respuestas[i]["respuesta_id"]);
        respuestas_body.appendChild(opcion);
      }
    }else{
      let tab_nueva_tarea = document.getElementById('tab_nueva_tarea');
        tab_nueva_tarea.setAttribute("hidden", "true");
      let letrero_nueva_tarea = document.getElementById('letrero_nueva_tarea');
        letrero_nueva_tarea.removeAttribute("hidden");
    }
    
  }

   function construir_listado_tareas(id_riesgo) {
    let tareas_riesgo = document.getElementById('tareas_riesgo');
    tareas_riesgo.innerHTML = "";
    let key = 'riesgo_'+id_riesgo;   
    if(lista_tareas.hasOwnProperty(key)){   
      let tareas = lista_tareas[key];
      for (var i = 0; i < tareas.length; i++) {
        let tarea = tareas[i];
        let temp = '<tr><td>'+tarea["tarea_nombre"]+'</td><td>'+tarea["tarea_descripcion"]+'</td><td>'+limpiar_string_fecha(tarea["fecha_inicio"])+'</td><td>'+limpiar_string_fecha(tarea["fecha_fin"])+'</td>';
        if("{{proyecto.proyecto_fin_status}}"==1){
          temp+=
          '<td><button type="button" class="btn btn-default" disabled = "true" data-toggle="#modal_eliminar" onclick="abrir_modal_editar_tarea(\''+tarea["tarea_id"]+'\', \''+tarea["tarea_nombre"]+'\', \''+tarea["tarea_descripcion"]+'\',\''+tarea["fecha_inicio"]+'\',\''+tarea["fecha_fin"]+'\')" data-target="#modal_eliminar"><i class="fa fa-edit"></i></button><button type="button" class="btn btn-danger" disabled = "true" data-toggle="#modal_eliminar" onclick="abrir_modal_eliminar_tarea(\''+tarea["tarea_id"]+'\', \''+tarea["tarea_nombre"]+'\',\''+tarea["tarea_descripcion"]+'\')" data-target="#modal_eliminar"><i class="fa fa-trash-o danger"></i></button></td></tr>';          
        }else{
          temp+=
        '<td><button type="button" class="btn btn-default" data-toggle="#modal_eliminar" onclick="abrir_modal_editar_tarea(\''+tarea["tarea_id"]+'\', \''+tarea["tarea_nombre"]+'\', \''+tarea["tarea_descripcion"]+'\',\''+tarea["fecha_inicio"]+'\',\''+tarea["fecha_fin"]+'\')" data-target="#modal_eliminar"><i class="fa fa-edit"></i></button><button type="button" class="btn btn-danger" data-toggle="#modal_eliminar" onclick="abrir_modal_eliminar_tarea(\''+tarea["tarea_id"]+'\', \''+tarea["tarea_nombre"]+'\',\''+tarea["tarea_descripcion"]+'\')" data-target="#modal_eliminar"><i class="fa fa-trash-o danger"></i></button></td></tr>';
        }       // 
        let gg = $.parseHTML(temp) 
        $(tareas_riesgo).append(gg);
      }
    }else{
      let tr = document.createElement("tr");   
      let td_nombre = document.createElement("td");       
      let td_descripcion = document.createElement("td");
      let td_fecha_inicio = document.createElement("td");
      let td_fecha_fin = document.createElement("td");
      let td_acciones = document.createElement("td");
      td_nombre.appendChild(document.createTextNode("No cuentas con tareas asociadas a este riesgo.")); 
      tr.appendChild(td_nombre);
      tr.appendChild(td_descripcion);
      tr.appendChild(td_fecha_inicio);
      tr.appendChild(td_fecha_fin);
      tr.appendChild(td_acciones);    
      tareas_riesgo.appendChild(tr);  
    }  
  }

function limpiar_string_fecha(fecha){
  let d = new Date(fecha);
  var datestring = d.getDate()  + "/" + (d.getMonth()+1) + "/" + d.getFullYear();
  return datestring;
}

function abrir_modal_eliminar_tarea(id_tarea, nombre_tarea) {                
    $("#modal_eliminar_tarea").modal('show');
    document.getElementById("contenido_modal_tarea").innerHTML = "¿Estas seguro que desea eliminar esta tarea de la acción? Esta podria tener asociados recursos.";
    document.getElementById("nombre_tarea").innerHTML = " "+nombre_tarea;
    var input_id = document.getElementById("tarea_id_e");
    input_id.value = id_tarea;
};

function abrir_modal_editar_tarea(id_tarea, nombre_tarea, descripcion, fecha_inicio, fecha_fin) {                
    $("#modal-editar-tarea").modal('show');
    var input_id = document.getElementById("tarea_id_ed");
    var input_nombre = document.getElementById("tarea_nombre_e");
    let fecha_inicio_ed = document.getElementById("tarea_fecha_inicio_ed");
    let fecha_fin_ed = document.getElementById("tarea_fecha_fin_ed");
    input_id.value = id_tarea;
    input_nombre.value = nombre_tarea;
    //console.log(fecha_inicio);
    fecha_inicio_ed.value = parsear_fecha(new Date(fecha_inicio));
    fecha_fin_ed.value = parsear_fecha(new Date(fecha_fin));
    document.getElementById("descripcion_tarea_e").innerHTML = " "+descripcion;

   
};


//////////////////////////////////////////////
// ./Funciones para el modal de tareas
//////////////////////////////////////////////


//////////////////////////////////////////////
// ./Funciones para el modal de recursos
//////////////////////////////////////////////
  function abrir_modal_recursos(id_riesgo) {    
    construir_select_tareas_for_recursos(id_riesgo);
    construir_listado_recursos(id_riesgo);
    $("#modal_recursos").modal('show');
    var input_id = document.getElementById("riesgo_id_re");
    input_id.value = id_riesgo;    
  }

  
  function construir_select_tareas_for_recursos(id_riesgo){  
    let recurso_form_nuevo = document.getElementById("recurso_form_nuevo");
    let recurso_letrero_uno = document.getElementById("recurso_letrero_uno");
    let recurso_letrero_dos = document.getElementById("recurso_letrero_dos");
    recurso_form_nuevo.removeAttribute("hidden");
    recurso_letrero_uno.setAttribute("hidden", "true");
    recurso_letrero_dos.setAttribute("hidden", "true");
    //Primero valido si el proyecto tiene recursos
    //console.log(cantidad_recursos);
    if(cantidad_recursos <= 0){
      recurso_form_nuevo.setAttribute("hidden", "true");
      recurso_letrero_uno.removeAttribute("hidden");
    }else{    
      let select_tarea = document.getElementById("tarea_id");
      select_tarea.innerHTML = "";
      let key = 'riesgo_'+id_riesgo;
     
      if(lista_tareas.hasOwnProperty(key)){   
        let tareas = lista_tareas[key];
        for (var i = 0; i < tareas.length; i++) {
          let opcion = document.createElement("option");
          opcion.appendChild(document.createTextNode(tareas[i]["tarea_nombre"]));
          opcion.setAttribute("value", tareas[i]["tarea_id"]);
          select_tarea.appendChild(opcion);
        }
      }else{
        recurso_form_nuevo.setAttribute("hidden", "true");
        recurso_letrero_dos.removeAttribute("hidden");
      }
    }
  }


function construir_listado_recursos(id_riesgo) {
    let listado_recursos = document.getElementById('listado_recursos');
    listado_recursos.innerHTML = "";
    let key = 'riesgo_'+id_riesgo;

    if(lista_tareas.hasOwnProperty(key)){   
      let tareas = lista_tareas[key];      
      for (var i = 0; i < tareas.length; i++) {
        let tarea = tareas[i];

        for(let j = 0; j < tarea["recursos"].length; j++){

          let recurso = tarea["recursos"][j];
          let temp = '<tr><td>'+tarea["tarea_nombre"]+'</td><td>'+recurso["recurso_nombre"]+'</td><td>'+recurso["cantidad"];

          if("{{proyecto.proyecto_fin_status}}"==1){
            temp+=
          '</td><td><button type="button" class="btn btn-danger" disabled = "true" data-toggle="#modal_eliminar" onclick="abrir_modal_desvincular_recurso(\''+recurso["recurso_id"]+'\', \''+recurso["recurso_nombre"]+'\', \''+tarea["tarea_nombre"]+'\', \''+tarea["tarea_id"]+'\')" data-target="#modal_eliminar"><i class="fa fa-trash-o danger"></i></button></td></tr>';
          }else{
          temp+=
          '</td><td><button type="button" class="btn btn-danger" data-toggle="#modal_eliminar" onclick="abrir_modal_desvincular_recurso(\''+recurso["recurso_id"]+'\', \''+recurso["recurso_nombre"]+'\', \''+tarea["tarea_nombre"]+'\', \''+tarea["tarea_id"]+'\')" data-target="#modal_eliminar"><i class="fa fa-trash-o danger"></i></button></td></tr>';}
          let gg = $.parseHTML(temp); 
          $(listado_recursos).append(gg);
        }
      }
    }else{
      let tr = document.createElement("tr");   
      let td_nombre = document.createElement("td");
      let td_descripcion = document.createElement("td");
      let td_acciones = document.createElement("td");
      td_nombre.appendChild(document.createTextNode("No cuentas con tareas asociadas a este riesgo.")); 
      tr.appendChild(td_nombre);
      tr.appendChild(td_descripcion);
      tr.appendChild(td_acciones);    
      listado_recursos.appendChild(tr);  
    }  
  }
          

  function abrir_modal_desvincular_recurso(id_recurso, nombre_recurso, nombre_tarea, id_tarea) {               
    $("#modal_desvincular_recurso").modal('show');
    document.getElementById("contenido_modal_recurso").innerHTML = "¿Estas seguro que desea desvincular este recurso de la tarea "+nombre_tarea +"?";
    document.getElementById("nombre_recurso").innerHTML = " "+nombre_recurso;
    var input_id = document.getElementById("recurso_id_e");
    var input_id_t = document.getElementById("tarea_id_e_r");
    input_id.value = id_recurso;
    input_id_t.value = id_tarea;
   
};

function mostrar_modal_informativo() {
  $('#modal-info').modal('show');
}

function crear_linea_base() {
  if(Object.keys(lista_tareas).length > 0){
     $.ajax({
        url: "{% url 'crear_linea_base' proyecto.proyecto_id %}",
        type: 'POST',
        headers: {'X-CSRFToken': csrftoken},      
        success: function(data) {
          Swal.fire(
            '¡ Registro exitoso !',
            'La linea base se ha creado con la fecha actual y esta disponible para controlar.',
            'success'
          ).then(function () {
            window.location.href = "{% url 'planificar_respuestas' proyecto.proyecto_id %}";
          });              
        }, error: function (jqXhr, textStatus, errorMessage) {
          console.log("Fallo Registro " + textStatus + errorMessage);
          Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: '¡ No se pudo crear la linea base !',             
              }).then(function () {
                window.location.href = "{% url 'planificar_respuestas' proyecto.proyecto_id %}";
              });
        }
      });
  }else{
    mostrar_modal_informativo();
  }
}
  
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

  function parsear_fecha(now){    
    var day = ("0" + now.getDate()).slice(-2);
    var month = ("0" + (now.getMonth() + 1)).slice(-2);
    var today = now.getFullYear()+"-"+(month)+"-"+(day) ;
    return today;
  }
</script>


{% endblock %}