{% extends "procesos/plantilla_procesos.html" %}

{% block title %} RISKO | {{ proyecto.proyecto_nombre }} {% endblock %}


{% block content %}



<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <div class="container">
    <section class="content-header"  style="margin-top: 70px;">
      <h1>
        {% if proyecto %}
        {{ proyecto.proyecto_nombre }}
        {% endif %}
        <small>Identificar riesgos</small>
      </h1>
      <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-folder-open"></i> Proyecto</a></li>
        <li class="active">Identificar Riesgos</li>
      </ol>
      {% if mensaje %}
    <div class="callout callout-info">
      <h4>Registro Exitoso</h4>
      {{mensaje}}      
    </div>
    {% endif %}
    {% if mensaje_eliminar %}
    <div class="callout callout-danger">
      <h4>Borrado Exitoso</h4>
      {{mensaje_eliminar}}      
    </div>
    {% endif %}

    {% if mensaje_editar %}
    <div class="callout callout-warning">
      <h4>Actualización Exitosa</h4>
      {{mensaje_editar}}      
    </div>
    {% endif %}
    </section>

    <section class="content">

       <div class="box">
            <div class="box-group" id="accordion">
              <div class="panel box box-primary">
                <div class="box-header with-border">
                  <h4 class="box-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" style="color:#444444";>
                      <label ><strong>Informe identificar riesgos - Proyecto: {{ proyecto.proyecto_nombre }}  <i class="fa fa-sort-desc"></i></strong></label>
                      
                      
                    </a>
                  </h4>
                </div>
                <div id="collapseThree" class="panel-collapse collapse in">
                  <div class="box-body">
                    Este proceso permite identificar los riesgos individuales y generales del proyecto para documentar sus características y las fuentes de riesgo que los generan. También, es posible asociar actividades del proyecto, responsables del riesgo y acciones de respuesta preliminares, que permitan atender adecuadamente a los riesgos identificados. A continuación podras descargar un informe del proceso identificar riesgos actualizado.
                  </br>
                   <a class="btn btn-primary  pull-right" href="{% url 'generar_informe_identificar' proyecto.proyecto_id %}">Generar informe</a>
                 </div>
               </div>
             </div>
           </div>
         </div>


         <!-- Identificar riesgos -->
         <div class="box box-primary">
          <div class="box-header with-border">
            <h4 class="box-title">
             <label data-toggle="tooltip" data-placement="top" title="En esta sección podra agregar riesgos al proyecto."><strong>Identificar riesgos - Proyecto: {{ proyecto.proyecto_nombre }}</strong></label>
           </h4>
         </div>
         <div class="nav-tabs-custom" style="cursor: move;">
          <!-- Tabs within a box -->
          <ul class="nav nav-tabs pull-right ui-sortable-handle">
            <li class="active"><a href="#revenue-chart" data-toggle="tab" aria-expanded="false"><label data-toggle="tooltip" data-placement="top" title="En esta sección podra agregar riesgos de su historial personal trabajado.">Historicos</label></a></li>

            <li class=""><a href="#sales-chart" data-toggle="tab" aria-expanded="true"><label data-toggle="tooltip" data-placement="top" title="En esta sección podra agregar riesgos sugeridos para el sector del proyecto.">Sugeridos</label></a></li>        
          </ul>            
          <div class="tab-content no-padding">
            <!-- Morris chart - Sales -->
            <div class="chart tab-pane active" id="revenue-chart" style="height: 300px; overflow:auto;">
              <div class="col-md-4">
                <div class="form-group">
                  <select class="form-control select2" id="riesgo_id" name="categorias" onchange="set_riesgo(this);">              
                  </select>
                </div>           
              </div>
              {% if proyecto.proyecto_fin_status %}
              <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal-default" disabled="true"><i class="fa fa-plus"></i> Nuevo Riesgo</button>
              {% else %}
              <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#nuevo-riesgo"><i class="fa fa-plus"></i> Nuevo Riesgo</button>
              {% endif %}        


              <div class="box-body">
                <div class="box-body">

                  <table id="example1" class="table table-bordered table-striped">
                    <thead>
                      <tr>
                        <th></th>
                        <th>Nombre</th>
                        <th>Causa</th>
                        <th>Evento</th>
                        <th>Efecto</th>
                        
                        
                      </tr>
                    </thead>
                    <tbody id="body_riesgos">
                      <tr>
                        <td></td>
                        <td>Selecciona una subcategoria para cargar los riesgos.</td> 
                        <td></td>
                        <td></td>
                        <td></td>                
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr>
                        <th></th>
                        <th>Nombre</th>
                        <th>Causa</th>
                        <th>Evento</th>
                        <th>Efecto</th>
                        
                        
                      </tr>
                    </tfoot>
                  </table>
                </div>                
              </div>          
            </div>
            <div class="chart tab-pane " id="sales-chart" style="position: relative; height: 300px; overflow:auto;">

              <!--<div class="box-body">-->
                <div class="box-body">
                  {% if lista_riesgos_sugeridos %}            

                    <table class="table table-bordered table-striped">
                    <thead>
                      <tr>
                        <th></th>
                        <th>Nombre</th>
                        <!--<th>Causa</th>
                        <th>Evento</th>
                        <th>Efecto</th>-->
                      </tr>
                    </thead>
                    <tbody>
                      {% for riesgo in lista_riesgos_sugeridos %}
                      <tr>
                        <td><input type="checkbox" value="{{riesgo.riesgo_id}}" name="riesgo_sugerido"></td>
                        <td>{{riesgo.riesgo_nombre}}</td> 
                        <!--<td>{{riesgo.riesgo_causa}}</td>
                        <td>{{riesgo.riesgo_evento}}</td>
                        <td>{{riesgo.riesgo_efecto}}</td>-->
                      </tr>
                      {% endfor %}
                    </tbody>
                    <tfoot>
                      <tr>
                        <th></th>
                        <th>Nombre</th>
                        <!--<th>Causa</th>
                        <th>Evento</th>
                        <th>Efecto</th>-->
                      </tr>
                    </tfoot>
                  </table>

                  {% else %}
                  <div class="pad margin no-print">
                    <div class="callout callout-info" style="margin-bottom: 0!important;">
                      <h4>Nota:</h4>
                      Hasta el momento no existen riesgos asociados al sector <strong>{{ proyecto.sector.sector_nombre }}</strong> en nuestro catalogo de riesgos. Por tal razón no podemos sugerirle riesgos para su proyecto. 
                    </div>
                  </div>
                  <table class="table table-bordered table-striped">
                    <thead>
                      <tr>
                        <th></th>
                        <th>Nombre</th>
                        <th>Causa</th>
                        <th>Evento</th>
                        <th>Efecto</th>         
                        
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td></td>
                        <td>No existen riesgos sugeridos actualmente.</td>              
                        <td></td>
                        <td></td>
                        <td></td>
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr>
                        <th></th>
                        <th>Nombre</th>
                        <th>Causa</th> 
                        <th>Evento</th>
                        <th>Efecto</th>
                                               
                      </tr>
                    </tfoot>
                  </table>
                  {% endif %}
                </div>
              <!--</div> -->
            </div>
            <div class="form-group">
              <div class="row no-print">
                <div class="col-md-11">
                  {% if proyecto.proyecto_fin_status %}
                  <button type="button" onclick="asosiar_riesgos('{{ proyecto.proyecto_id }}');" class="btn btn-success pull-right" disabled="true"><i class="fa fa-plus"></i> Agregar
                  </button>  
                  {% else %}
                 <button type="button" onclick="asosiar_riesgos('{{ proyecto.proyecto_id }}');" class="btn btn-success pull-right"><i class="fa fa-plus"></i> Agregar
                  </button>  
                  {% endif %}                   
                </div>
              </div>
              <br>
            </div>
          </div>

        </div>
      </div>
      <!-- Cerrar Identificar riesgos-->
        
  <div class="box box-primary">
      <div class="box-header with-border">
        <h4 class="box-title">
        <label data-toggle="tooltip" data-placement="top" title="En esta sección podrá administrar los riesgos del proyecto."><strong>Riesgos identificados - Proyecto: {{ proyecto.proyecto_nombre }}</strong></label>
        </h4>
      </div>
      <div class="box-body">

        <div class="box-body">

          <table id="tabla_riesgos" class="table table-bordered table-striped">
            <thead>
              <tr>
                <th></th>
                <th>Riesgo &nbsp<i class="fa fa-long-arrow-down"><i class="fa fa-long-arrow-up"></th>
                <th><label data-toggle="tooltip" data-placement="top" title="Actividades del cronograma del proyecto afectadas por el riesgo.">Actividades</label></th>
                <th><label data-toggle="tooltip" data-placement="top" title="Responsable asignado al riesgo.">Responsable</label></th>
                <th><label data-toggle="tooltip" data-placement="top" title="Acciones de respuesta preliminares asociadas al riesgo.">Acciones de respuesta</label></th>
                <th><label data-toggle="tooltip" data-placement="top" title="Acciones e información relacionada al riesgo.">Opciones</label></th>                    
              </tr>
            </thead>
            <tbody>
             {% if lista_riesgos %}
             {% for riesgo in lista_riesgos %}
             <tr>
              <td></td>
              <td>{{ riesgo.riesgo_nombre }}</td>

              <td>
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#modal-actividades"  onclick="abrir_modal_actividades('{{ riesgo.riesgo_id }}')"><i   class="fa fa-edit"></i></button>

              </td>
              <td>
                <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#modal-responsables" onclick="abrir_modal_responsables('{{ riesgo.riesgo_id }}')"><i   class="fa fa-edit"></i></button>
              </td>
              <td> 
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal-respuestas" onclick="abrir_modal_respuestas('{{ riesgo.riesgo_id }}')"><i   class="fa fa-edit"></i></button>
              </td>
              <td>
                <button type="button" class="btn btn-info" data-toggle="modal" onclick="abrir_modal_informacion_riesgo(' {{ riesgo.riesgo_nombre }}', '{{ riesgo.riesgo_causa }}',' {{ riesgo.riesgo_evento }}', ' {{ riesgo.riesgo_efecto }}', '{{ riesgo.riesgo_tipo }}', '{{ riesgo.fecha_manifestacion }}')">&nbsp<i   class="fa fa-info">&nbsp</i>
                </button>

                {% if proyecto.proyecto_fin_status %}
                 <button type="button" class="btn btn-default" data-toggle="modal" onclick="abrir_modal_editar_riesgo('{{ riesgo.riesgo_id }}','{{ riesgo.riesgo_nombre }}', '{{ riesgo.riesgo_causa }}','{{ riesgo.riesgo_evento }}', '{{ riesgo.riesgo_efecto }}',   '{{ riesgo.riesgo_tipo }}', '{{riesgo.fecha_manifestacion}}')" disabled="true"><i   class="fa fa-edit"></i>
                </button>


                <button type="button" class="btn btn-danger" data-toggle="#modal" onclick="abrir_modal_eliminar('{{ riesgo.riesgo_id }}',' {{ riesgo.riesgo_nombre }}')" data-target="#modal_eliminar" disabled="true"><i class="fa fa-trash-o danger"></i>
                </button>
                {% else %}
                 <button type="button" class="btn btn-default" data-toggle="modal" onclick="abrir_modal_editar_riesgo('{{ riesgo.riesgo_id }}','{{ riesgo.riesgo_nombre }}', '{{ riesgo.riesgo_causa }}','{{ riesgo.riesgo_evento }}', '{{ riesgo.riesgo_efecto }}',   '{{ riesgo.riesgo_tipo }}', '{{riesgo.fecha_manifestacion}}')"><i   class="fa fa-edit"></i>
                </button>


                <button type="button" class="btn btn-danger" data-toggle="#modal" onclick="abrir_modal_eliminar('{{ riesgo.riesgo_id }}',' {{ riesgo.riesgo_nombre }}')" data-target="#modal_eliminar"><i class="fa fa-trash-o danger"></i>
                </button>
                {% endif %}  


               
              </td>                   
              
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td></td>
              <td>No cuentas con riesgos registrados.</td>
              <td></td> 
              <td></td>
              <td></td>
              <td></td>
            </tr>
            {% endif %} 
          </tbody>
          <tfoot>
            <tr>
              <th></th>
              <th>Riesgo</th>                
              <th>Actividades</th>
              <th>Responsables</th>
              <th>Acciones de Respuesta</th>
              <th>Opciones</th>    
            </tr>
          </tfoot>
        </table>
      </div>    

    </div>
    <!-- /.box-body -->
  </div>

</section>
</div>
</div>

<div class="modal fade" id="nuevo-riesgo" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span></button>
        <h4 class="modal-title">Riesgo</h4>
      </div>
      <div class="modal-body">
        <div class="box-body" id="body_nuevo_riesgo">
        <form id="nuevo_riesgo">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <div class="form-group">
                  <label >Nombre Riesgo</label>
                  <input type="text" class="form-control" id="nombre" placeholder="Ingrese Nombre del riesgo" maxlength="45" name="riesgo_nombre" required>
                </div>
                <div class="form-group">
                  <label>Subcategoría a la que pertence</label>              
                  <select class="form-control" name="sub_categoria_id" id="sub_categoria_id" required="">    
                  </select>
                </div>
                <div class="form-group">
                  <label>Causa</label>
                  <textarea class="form-control" rows="5" placeholder="Descripción de la causa..." name="riesgo_causa" maxlength="3000" required></textarea>
                </div> 
                
              </div>
            </div>
            <!-- /.col -->
            <div class="col-md-6">             
              <div class="form-group">
                <label>Tipo</label>
                <select class="form-control select2" style="width: 100%;" name="riesgo_tipo" required>
                  <option selected="selected" value="0">Riesgo</option>
                  <option value="1">Oportunidad</option>

                </select>
              </div> 
              <div class="form-group">
                <label>Efecto</label>
                <textarea class="form-control" rows="3" placeholder="Descripción del efecto..." name="riesgo_efecto" maxlength="3000" required></textarea>
              </div>
              <div class="form-group">
                  <label>Evento</label>
                  <textarea class="form-control" rows="3" placeholder="Descripción del evento..." name="riesgo_evento" maxlength="3000" required></textarea>
                </div>
              {% if proyecto %}
                <input type="text" name="proyecto_id" value="{{ proyecto.proyecto_id }}" hidden>
              {% endif %}
              <div class="box-footer">
                <button type="submit" class="btn btn-danger pull-right">Registrar</button>
                <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cerrar</button>
              </div>
            </div>
            <!-- /.col -->
          </div>
          <!-- /.row -->
        </form>        
      </div>
      </div>    
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>
<!-- /modal respuestas -->
<div class="modal fade" id="modal_respuestas">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"><i class="fa fa-edit"></i> Acciones de respuesta preliminares</h4>
        </div>
        <div class="modal-body">

         <div class="nav-tabs-custom">
          <!-- Tabs within a box -->
          <ul class="nav nav-tabs pull-right">
            <li class="active"><a href="#listado-respuestas" data-toggle="tab"> Listado</a></li>
            <li ><a href="#nueva-respuesta" data-toggle="tab">Nueva Acción</a></li>            

          </ul>
          <div class="tab-content no-padding">
            <!-- Morris chart - Sales -->
            <div class="chart tab-pane active" id="listado-respuestas" style="position: relative; height: 300px; overflow-y: scroll;">

             <div class="box-body">

              <table id="tabla2" class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>Accion de respuesta</th>
                    <th>Descripción</th>                  
                    <th>Acciones</th>                    
                  </tr>
                </thead>
                <tbody id="respuestas_body">                 
                  <tr>
                    <td>No cuentas con respuestas asociadas a este riesgo.</td>
                    <td></td> 
                    <td></td>                
                  </tr>
                </tbody>
              <tfoot>
                <tr>
                  <th>Accion de respuesta</th>
                  <th>Descripción</th>                  
                  <th>Acciones</th>      
                </tr>
              </tfoot>
            </table>
          </div>  

        </div>
        <div class="chart tab-pane" id="nueva-respuesta" style="position: relative; height: 300px;">
         <div class="box-body">
          <form action="{% url 'nueva_respuesta_identificar' proyecto.proyecto_id %}" method="post">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <div class="form-group">
                    <label >Nombre</label>
                    <input type="text" class="form-control" id="respuesta_nombre" maxlength="44" placeholder="Nombre acción de respuesta" name="respuesta_nombre">
                  </div>
                </div>
                <div class="form-group">
                  <div class="form-group">
                    <label >Tipo de Acción</label>
                    <select class="form-control select2" id="responsable_id" name="tipo_respuesta">
                      <optgroup label="Riesgo">
                        <option value="Mitigar">
                         Mitigar
                       </option>
                       <option value="Evitar">
                         Evitar
                       </option>
                       <option value="Transferir">
                         Transferir
                       </option>
                       <option value="Aceptar">
                         Aceptar
                       </option>
                     </optgroup> 
                     <optgroup label="Oportunidades">
                      <option value="Explotar">
                       Explotar
                     </option>
                     <option value="Compartir">
                       Compartir
                     </option>
                     <option value="Mejorar">
                       Mejorar
                     </option>
                     <option value="Aceptar">
                       Aceptar
                     </option>
                   </optgroup>                  
                 </select>
               </div>
             </div>
             <!-- / input para pasar el id del riesgo al asociarle la respuesta -->
             <input type="text" class="form-control" id="riesgo_id_r" name="riesgo_id" style="visibility:hidden">
           </div>           
           <div class="col-md-6">
            <div class="form-group">
                  <label>Descripción</label>
                  <textarea class="form-control" rows="3" maxlength="3000" placeholder="Descripción de la acción de respuesta preliminar" name="respuesta_descripcion"></textarea>
                </div>
                <div class="box-footer">

                  {% if proyecto.proyecto_fin_status %}
                  <button type="submit" class="btn btn-primary pull-right" disabled="true">Registrar</button> 
                  {% else %}
                  <button type="submit" class="btn btn-primary pull-right">Registrar</button>
                  {% endif %} 
                  
                </div>
              </div>
              <!-- /.col -->
            </div>
            <!-- /.row -->
          </form>
        </div><!-- /.box-body -->
      </div>     
    </div>
  </div>
</div>
</div>
<!-- /.modal-content -->
</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->


<!-- /.modal actividades -->
<div class="modal fade" id="modal_actividades">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"><i class="fa fa-edit"></i> Actividades</h4>
        </div>
        <div class="modal-body">

         <div class="nav-tabs-custom">
          <!-- Tabs within a box -->
          <ul class="nav nav-tabs pull-right">
            <li class="active"><a href="#listado-actividades" data-toggle="tab"> Listado</a></li>
            <li ><a href="#nueva-actividad" data-toggle="tab">Nueva Actividad</a></li>            

          </ul>
          <div class="tab-content no-padding">
            <!-- Morris chart - Sales -->
            <div class="chart tab-pane active" id="listado-actividades" style="position: relative; height: 300px;">

             <div class="box-body">

              <table id="tabla2" class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Acciones</th>                                      
                  </tr>
                </thead>
                <tbody id="cuerpo_actividades_riesgos">
                 
              </tbody>
              <tfoot>
                <tr>
                  <th>Nombre</th>
                  <th>Acciones</th>      
                </tr>
              </tfoot>
            </table>
          </div>  

        </div>
        <div class="chart tab-pane" id="nueva-actividad" style="position: relative; height: 300px;">
         <div class="box-body">
          <form action="{% url 'nueva_actividad_riesgo' proyecto.proyecto_id %}" method="post">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-12">
                <div class="form-group">
                  <div id="bloq_subcategorias" class="form-group">
                    <label>Actividades</label>
                    
                 </div>
               </div>
               <!-- / input para pasar el id del riesgo al asociarle la actividad -->
               <input type="text" class="form-control" id="riesgo_id_ac" name="riesgo_id" style="visibility:hidden">
               {% if proyecto.proyecto_fin_status %}
               <button type="submit" class="btn btn-primary pull-right" disabled="true">Agregar</button>  
               {% else %}
               <button type="submit" id="btn_agregar_actividad" class="btn btn-primary pull-right">Agregar</button>
               {% endif %}   
               
             </div>
             <!-- /.col -->
           </div>
           <!-- /.row -->
         </form>
       </div><!-- /.box-body -->
     </div>     
    </div>
  </div>
</div>
</div>
<!-- /.modal-content -->
</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->
<!-- /.modal responsables -->
<div class="modal fade" id="modal_responsables">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"><i class="fa fa-edit"></i> Responsables</h4>
        </div>
        <div class="modal-body">

         <div class="nav-tabs-custom">
          <!-- Tabs within a box -->
          <ul class="nav nav-tabs pull-right">
            <li class="active"><a href="#listado-responsables" data-toggle="tab"> Listado</a></li>
            <li ><a href="#nuevo-responsable" data-toggle="tab">Nuevo Responsable</a></li>            

          </ul>
          <div class="tab-content no-padding">
            <!-- Morris chart - Sales -->
            <div class="chart tab-pane active" id="listado-responsables" style="position: relative; height: 300px;">

             <div class="box-body">
               <table id="tabla_responsables" class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Acciones</th>                                      
                  </tr>
                </thead>
                <tbody id="responsables_by_riesgo">         
                  
                </tbody>
                <tfoot>
                  <tr>
                    <th>Nombre</th>
                    <th>Acciones</th>      
                  </tr>
                </tfoot>
              </table>
            </div>  

        </div>
        <div class="chart tab-pane" id="nuevo-responsable" style="position: relative; height: 300px;">
         <div class="box-body">
          <form action="{% url 'nuevo_responsable_riesgo' proyecto.proyecto_id %}" method="post">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-12">
                <div class="form-group">
                  <div id="bloq_subcategorias" class="form-group">
                    <label>Responsables</label>
                    {% if lista_responsables %}                    
                    <select class="form-control select2" id="responsable_id" name="responsable_id">
                      {% for responsable in lista_responsables %}
                      <option value="{{ responsable.responsable_id }}">
                       {{ responsable.responsble_nombre }}
                     </option>
                     {% endfor %}
                     {% else %}
                     <div class="alert alert-info alert-dismissible"><h4><i class="icon fa fa-info"></i>  Atencion</h4> Hasta el momento este proyecto no cuenta con un equipo de gestion de riesgos para poder asignar reponsables<br/></br> Si usted lo desea, puede definir su equipo de gestion de riesgos dando clic 
                  <a href="{% url 'mi_proyecto_planificar' proyecto.proyecto_id %}">aqui</a></div>
                     {% endif %} 
                   </select>
                 </div>
               </div>
               <!-- / input para pasar el id del riesgo al asociarle la actividad -->
               <input type="text" class="form-control" id="riesgo_id_re" name="riesgo_id" style="visibility:hidden">
               {% if proyecto.proyecto_fin_status %}
               <button type="submit" class="btn btn-primary pull-right" disabled="true">Agregar</button>  
               {% else %}
               <button type="submit" class="btn btn-primary pull-right">Agregar</button>
               {% endif %} 
               
             </div>
             <!-- /.col -->
           </div>
           <!-- /.row -->
         </form>
       </div><!-- /.box-body -->
     </div>     
   </div>
 </div>
</div>
</div>
<!-- /.modal-content -->
</div>
<!-- /.modal-dialog -->
</div>

 <!-- /.modal-editar -->
 <div class="modal fade" id="modal-informacion"> 
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Información del Riesgo</h4>
          </div>
          <div class="box-body">
          
          <form>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                <label >Nombre </label>
                <p id="nombre_riesgo_info"></p>
                </div>
               
                <div class="form-group">
                  <label>Causa</label>
                  <p id="causa_riesgo_info"></p>
                </div>
                <div class="form-group">
                  <label>Evento</label>
                  <p id="evento_riesgo_info"></p>
                </div>
              </div>
              <!-- /.col -->
              <div class="col-md-6">                                
                <div class="form-group">
                <label >Tipo Riesgo</label>
                  <p id="tipo_riesgo_info"></p>                
                </div>                
                <div class="form-group">
                  <label>Efecto</label>
                  <p id="efecto_riesgo_info"></p>
                </div>
                <!--
                <div class="form-group">
                  <label>Fecha manifestación</label>
                  <p id="fecha_riesgo_info"></p>
                </div> -->
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary pull-right" data-dismiss="modal">Cerrar</button>
              
            </div>
            <!-- /.row -->
          </form>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>


<!-- /.modal -->
  <!-- /.modal-editar -->
 <div class="modal fade" id="modal-editar"> 
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Editar Riesgo</h4>
          </div>
          <div class="box-body">
          {% if proyecto %}
          <form action="{% url 'editar_riesgo_proyecto' proyecto.proyecto_id %}" method="post">
          {% else %}  
          <form action="#" method="post">
          {% endif %}

            {% csrf_token %}
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                <label >Nombre </label>
                <input type="text" class="form-control" maxlength="44" id="riesgo_nombre" name="riesgo_nombre">
                </div>
               
                <div class="form-group">
                  <label>Causa</label>
                  <textarea class="form-control" rows="3" maxlength="3000" id="riesgo_causa" name="riesgo_causa"></textarea>
                </div>
                <div class="form-group">
                  <label>Evento</label>
                  <textarea class="form-control" rows="3" maxlength="3000" id="riesgo_evento" name="riesgo_evento"></textarea>
                </div>
              </div>
              <!-- /.col -->
              <div class="col-md-6">                                
                <div class="form-group">
                <label >Tipo Riesgo</label>
                  <select class="form-control"  name="riesgo_tipo" id="riesgo_tipo"> 
                    <option value="0">Riesgo</option>
                    <option value="1">Oportunidad</option>
                  </select>                
                </div>
                <div class="form-group">
                  <label>Efecto</label>
                  <textarea class="form-control" rows="3" maxlength="3000" id="riesgo_efecto" name="riesgo_efecto"></textarea>
                </div>
                <!--<div class="form-group">
                  <label>Fecha de Manifestación</label>
                  <div class="input-group date">
                  <div class="input-group-addon">
                    <i class="fa fa-calendar"></i>
                  </div>
                  <input type="date" class="form-control pull-right" id="riesgo_fecha_manifestacion_id" name="riesgo_fecha_manifestacion">
                </div>
                </div>-->
                <input type="text" class="form-control" id="riesgo_id_editar" name="riesgo_id_editar" style="visibility: hidden;">

              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary pull-left" data-dismiss="modal">Cerrar</button>
              <button type="submit" class="btn btn-primary pull-right">Actualizar</button>
            </div>
            <!-- /.row -->
          </form>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>


<!-- /.modal-eliminar -->

  <div class="modal modal-danger fade" id="modal_eliminar" >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title"> Eliminar </h4>
          </div>
          <form  action="{% url 'eliminar_riesgo_proyecto' proyecto.proyecto_id %}" method="post">
            {% csrf_token %}
          <div class="modal-body">
            <p id="contenido_modal">&hellip;</p>
            <h2 id="nombre_riesgo_me"></h2>
            <input type="text" class="form-control" id="riesgo_id_e" name="riesgo_id" style="visibility:hidden">            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline pull-left" data-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-outline">Eliminar</button>
          </div>
          </form>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
<!-- /.modal-eliminar -->
  <div class="modal modal-danger fade" id="modal_eliminar_responsable" >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title"> Eliminar </h4>
          </div>
          <form  action="{% url 'eliminar_responsable_riesgo' proyecto.proyecto_id %}" method="post">
            {% csrf_token %}
          <div class="modal-body">
            <p id="contenido_modal_re">&hellip;</p>
            <h2 id="nombre_riesgo_re">rrrr</h2>            
            <input type="text" class="form-control" id="riesgo_id_e_r" name="riesgo_id" style="visibility: hidden;">      
            <input type="text" class="form-control" id="responsable_id_e_r" name="responsable_id" style="visibility: hidden;">       
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline pull-left" data-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-outline">Eliminar</button>
          </div>
          </form>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
<!-- modal eliminar actividad -->
  <div class="modal modal-danger fade" id="modal_eliminar_actividad" >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"> Eliminar </h4>
        </div>
        <form  action="{% url 'eliminar_actividad_proyecto' proyecto.proyecto_id %}" method="post">
          {% csrf_token %}
          <div class="modal-body">
            <p id="contenido_modal_actividad">&hellip;</p>
            <h2 id="nombre_actividad_me"></h2>
            <input type="text" class="form-control" id="riesgo_id_actividad" name="riesgo_id_actividad" style="visibility:hidden">
            <input type="text" class="form-control" id="actividad_id_riesgo" name="actividad_id_riesgo" style="visibility:hidden">              
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline pull-left" data-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-outline">Eliminar</button>
          </div>
        </form>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
<!-- modal eliminar actividad -->

  <div class="modal modal-danger fade" id="modal_eliminar_respuesta" >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"> Eliminar </h4>
        </div>
        <form  action="{% url 'desasociar_respuesta_identificar' proyecto.proyecto_id %}" method="post">
          {% csrf_token %}
          <div class="modal-body">
            <p id="contenido_modal_eliminar_respuesta">&hellip;</p>
            <h2 id="nombre_rta_me"></h2>
            <input type="text" class="form-control" id="respuesta_id_eliminar" name="respuesta_id_eliminar" style="visibility: hidden;" />         
            <input type="text" class="form-control" id="riesgo_id_eliminar" name="riesgo_id_eliminar" style="visibility: hidden;" />               
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline pull-left" data-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-outline">Eliminar</button>
          </div>
        </form>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>







{% endblock %}

{% block mis_scrtips_riesgos %}

{% load static %}
<!-- DataTables -->
<script src="{% static 'risk_project/bower_components/datatables.net/js/jquery.dataTables.min.js' %}"></script>


<script src="{% static 'risk_project/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>




<!-- AdminLTE for demo purposes -->
<script src="{% static 'risk_project/dist/js/demo.js' %}"></script>

{% endblock %}


{% block organigrama_down %}
{% load static %}
<script src="{% static 'risk_project/dist/js/risk_ufps/risk_config.js' %}"></script>
<script src="{% static 'risk_project/plugins/sweetalert/sweetalert.js' %}"></script>



  <script type="text/javascript">
  
  //////////////////////////////////////////
  // Variables globales
  /////////////////////////////////////////

  var data = JSON.parse("{{rbs|escapejs}}"); 

  console.log(data);  

  var respuestas_riesgo = JSON.parse("{{respuestas_riesgo|escapejs}}");   

  var actividades = JSON.parse("{{lista_actividades|escapejs}}");   

  var actividades_riesgo = JSON.parse("{{actividades_riesgo|escapejs}}");

  console.log(respuestas_riesgo);

  console.log(actividades_riesgo);

  var diccionario = {};

  var responsables_riesgo = JSON.parse("{{responsables_riesgo|escapejs}}");

  console.log('responsables_riesgo',responsables_riesgo);

function formatear_data(){  
  data.forEach(function(element){
    diccionario[element["categoria"]["categoria_id"]] = element["subcategorias"];
  });
}

function cargarCategorias() {
    addOptions("categorias", data);
    addOptions("sub_categoria_id", data);
}


//Función para agregar opciones a un <select>.
function addOptions(domElement, mi_array) {
    var selector = document.getElementsByName(domElement)[0];
    selector.innerHTML = '<option value="">Seleccione una Categoria...</option>'
    for (var i = 0; i < mi_array.length; i++) {
        var optgroup = document.createElement("optgroup");
        optgroup.setAttribute("label", mi_array[i]["categoria"]["categoria_nombre"]);
        for (var j = 0; j < mi_array[i]["subcategorias"].length; j++) {
          var opcion = document.createElement("option");
          opcion.text = mi_array[i]["subcategorias"][j]["subcategoria"]["sub_categoria_nombre"];        
          opcion.value = mi_array[i]["subcategorias"][j]["subcategoria"]["sub_categoria_id"];
          optgroup.appendChild(opcion);
        }                 
        selector.add(optgroup);
    }
}
cargarCategorias();

function set_riesgo(subcategoria){
  let body_riesgos = document.getElementById('body_riesgos');
  body_riesgos.innerHTML = "";
  let riesgos = get_riesgos_by_sub_categoria_id(subcategoria.value);
  let flag = false;
  let construidos = 0;
  for (var i = 0; i < riesgos.length; i++) {     
    if(!riesgos[i]["is_assigned"]){
      let tr = document.createElement("tr");   
      let input = document.createElement("input");
      input.setAttribute("type", "checkbox");
      input.setAttribute("value", riesgos[i]["riesgo_id"]);
      input.setAttribute("name", "riesgo_propio");
      let td_nombre = document.createElement("td");
      td_nombre.appendChild(document.createTextNode(riesgos[i]["riesgo_nombre"]));
      let td_causa = document.createElement("td");
      td_causa.appendChild(document.createTextNode(riesgos[i]["riesgo_causa"]));
      let td_evento = document.createElement("td");
      td_evento.appendChild(document.createTextNode(riesgos[i]["riesgo_evento"]));
      let td_efecto = document.createElement("td");
      td_efecto.appendChild(document.createTextNode(riesgos[i]["riesgo_efecto"]));
      tr.appendChild(input);
      tr.appendChild(td_nombre);
      tr.appendChild(td_causa);
      tr.appendChild(td_evento);
      tr.appendChild(td_efecto);
      body_riesgos.appendChild(tr);
      construidos = construidos + 1;
    }       
  }
  if(construidos == 0){
    let tr = document.createElement("tr");   
    let td_nombre = document.createElement("td");
    td_nombre.appendChild(document.createTextNode("No existen riesgos para agregar para esta sección."));
    tr.appendChild(document.createElement("td"));
    tr.appendChild(td_nombre);
    body_riesgos.appendChild(tr);
  }
}

function get_riesgos_by_sub_categoria_id(sub_categoria_id) {
  for (var i = 0; i < data.length; i++) {                  
    for (var j = 0; j < data[i]["subcategorias"].length; j++) {
      if(data[i]["subcategorias"][j]["subcategoria"]["sub_categoria_id"] == sub_categoria_id){
        return data[i]["subcategorias"][j]["riesgos"];
      }      
    }                       
  }
}

function asosiar_riesgos(proyecto_id){
  let riesgos_seleccionados = $("input[type = 'checkbox'][name = 'riesgo_propio']:checked");
  let riesgos_sugeridos = $("input[type = 'checkbox'][name = 'riesgo_sugerido']:checked");
  console.log(riesgos_sugeridos);
  let aux = [];
  let aux_sugeridos = [];
  if( riesgos_seleccionados.length > 0 || riesgos_sugeridos.length > 0){
    for (var i = 0; i < riesgos_seleccionados.length; i++) {
    aux.push(riesgos_seleccionados[i].value);
  }
  for (var i = 0; i < riesgos_sugeridos.length; i++) {
    aux_sugeridos.push(riesgos_sugeridos[i].value);
  }
  $.ajax({
    type: 'POST',
    url: "{% url 'asociar_riesgo' proyecto.proyecto_id %}",   
    headers: {'X-CSRFToken': csrftoken},   
    //contentType:'json',   
    data: {"riesgos_seleccionados":JSON.stringify(aux), "riesgos_sugeridos": JSON.stringify(aux_sugeridos)},
    success: function(data, status, xhr) {
       Swal.fire(
          '¡ Registro exitoso !',
          'los riesgos se han agregado',
          'success'
        ).then(function () {
          location.reload();
        });          
    },
    error: function(jqXhr, textStatus, errorMessage) {
      console.log(errorMessage);
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: '¡ No se pudo registrar los riesgos  !',             
      }).then(function () {
        location.reload();
      });
    }
  });
  }  
}
</script>
<script >
  function abrir_modal_respuestas(id_riesgo) {
    let respuestas_body = document.getElementById('respuestas_body');
    respuestas_body.innerHTML = "";
    let key = 'riesgo_'+id_riesgo;
   
    if(respuestas_riesgo.hasOwnProperty(key)){   
      let respuestas = respuestas_riesgo[key];
      for (var i = 0; i < respuestas.length; i++) {
        let tr = document.createElement("tr");   
        let td_nombre = document.createElement("td");
        let td_descripcion = document.createElement("td");
        let td_acciones = document.createElement("td");
        td_nombre.appendChild(document.createTextNode(respuestas[i]["respuesta_nombre"]));
        td_descripcion.appendChild(document.createTextNode(respuestas[i]["respuesta_descripcion"]));
        let boton = document.createElement("button");
        boton.setAttribute("type", "button");
        boton.setAttribute("class", "btn btn-danger");
        
        boton.setAttribute("data-toggle", "#modal_eliminar_respuesta");
        boton.setAttribute(
          "onclick", 
          "abrir_modal_eliminar_respuesta('"+id_riesgo+"','"+respuestas[i]["respuesta_id"]+"','"+respuestas[i]["respuesta_nombre"]+"');" );
        boton.setAttribute("data-target", "#modal_eliminar_respuesta");
        let mi_icon = document.createElement("i");
        mi_icon.setAttribute("class", "fa fa-trash-o danger")
        if("{{proyecto.proyecto_fin_status}}"==1){
          boton.setAttribute("disabled", "true");
        }


        boton.appendChild(mi_icon);
        td_acciones.appendChild(boton);
        tr.appendChild(td_nombre);
        tr.appendChild(td_descripcion);
        tr.appendChild(td_acciones);  
        respuestas_body.appendChild(tr);
      }
    }else{
      let tr = document.createElement("tr");   
      let td_nombre = document.createElement("td");
      let td_descripcion = document.createElement("td");
      let td_acciones = document.createElement("td");
      td_nombre.appendChild(document.createTextNode("No cuentas con respuestas asociadas a este riesgo.")); 
      tr.appendChild(td_nombre);
      tr.appendChild(td_descripcion);
      tr.appendChild(td_acciones);    
      respuestas_body.appendChild(tr);  
    }
    
    $("#modal_respuestas").modal('show');
    var input_id = document.getElementById("riesgo_id_r");
    input_id.value = id_riesgo;  
  };




  function abrir_modal_actividades(id_riesgo) {        

        $("#modal_actividades").modal('show');
        var input_id = document.getElementById("riesgo_id_ac");
        input_id.value = id_riesgo;
        construir_listado_actividades_riesgos(id_riesgo);
        return false;
    };

  function abrir_modal_responsables(id_riesgo, responsables) {               
    var input_id = document.getElementById("riesgo_id_re");
    input_id.value = id_riesgo;
    var responsables_by_riesgo = document.getElementById("responsables_by_riesgo");
    responsables_by_riesgo.innerHTML = '';
    if(responsables_riesgo.length > 0){
      for (var i = 0; i < responsables_riesgo.length; i++) {
        if(responsables_riesgo[i]['riesgo_id'] == id_riesgo){
          let str = '<tr><td>'+responsables_riesgo[i]["responsble_nombre"]+'</td><td><button type="button" class="btn btn-danger" data-toggle="#modal_eliminar_responsable_" onclick="abrir_modal_eliminar_responsable(\''+responsables_riesgo[i]["responsable_id"]+'\', \''+responsables_riesgo[i]["responsble_nombre"]+'\', \''+id_riesgo+'\')" data-target="#modal_eliminar"><i class="fa fa-trash-o danger"></i></button></td></tr>';
          let html = $.parseHTML(str);
          $(responsables_by_riesgo).append(html);
        }
      }
    }else{
      let str = '<td>No cuentas con responsables asociados a este riesgo.</td><td></td>';
      let html = $.parseHTML(str);
      $(responsables_by_riesgo).append(html);
    }
     $("#modal_responsables").modal('show');
  };



  function abrir_modal_informacion_riesgo(nombre, causa, evento, efecto, tipo, fecha) {        

        $("#modal-informacion").modal('show');
        tipo_nombre = tipo == 0 ? 'Riesgo':'Oportunidad';
        document.getElementById("nombre_riesgo_info").innerHTML = " "+nombre;
        document.getElementById("causa_riesgo_info").innerHTML = " "+causa;
        document.getElementById("evento_riesgo_info").innerHTML = " "+evento;
        document.getElementById("efecto_riesgo_info").innerHTML = " "+efecto;
        document.getElementById("tipo_riesgo_info").innerHTML = " "+tipo_nombre;
        //document.getElementById("fecha_riesgo_info").innerHTML = " "+ fecha;
        
        
        return false;
    };




  function abrir_modal_editar_riesgo(riesgo_id, riesgo_nombre, riesgo_causa, riesgo_evento, riesgo_efecto, riesgo_tipo, fecha_manifestacion){
    console.log("MUCHA FECHA", parsear_fecha(new Date(fecha_manifestacion)));
    $("#riesgo_id_editar").val(riesgo_id);
     $("#riesgo_nombre").val(riesgo_nombre);
      $("#riesgo_causa").val(riesgo_causa);
       $("#riesgo_evento").val(riesgo_evento);
        $("#riesgo_efecto").val(riesgo_efecto);
         $("#riesgo_tipo").val(riesgo_tipo);
         $("#riesgo_fecha_manifestacion_id").val(fecha_manifestacion);
    $("#modal-editar").modal('show');
        
  }

  function abrir_modal_eliminar(id, nombre) {        
    console.log("id", id);
    console.log("nombre", nombre);
    $("#modal_eliminar").modal('show');
    document.getElementById("contenido_modal").innerHTML = "Estas seguro que desea eliminar el riesgo del proyecto?";
    document.getElementById("nombre_riesgo_me").innerHTML = " "+nombre;
    var input_id = document.getElementById("riesgo_id_e");
    input_id.value = id;        
  };

  function abrir_modal_eliminar_responsable(id_responsable, nombre, id_riesgo) {        
    //console.log("id", id);
    //console.log("nombre", nombre);
    $("#modal_eliminar_responsable").modal('show');
    document.getElementById("contenido_modal_re").innerHTML = "¿Estas seguro que desea eliminar este responsable del riesgo?";
    document.getElementById("nombre_riesgo_re").innerHTML = " "+nombre;
    var input_id = document.getElementById("riesgo_id_e_r");
    input_id.value = id_riesgo;        
    document.getElementById('responsable_id_e_r').value = id_responsable;        
  };

  function abrir_modal_eliminar_actividad(riesgo_id, actividad_id, actividad_nombre) {        
    $("#modal_eliminar_actividad").modal('show');
    document.getElementById("contenido_modal_actividad").innerHTML = "¿Estas seguro que desea desasociar esta actividad del riesgo?";
    document.getElementById("nombre_actividad_me").innerHTML = " "+actividad_nombre;
    document.getElementById("riesgo_id_actividad").value = riesgo_id;        
    document.getElementById("actividad_id_riesgo").value = actividad_id;
  };

  function abrir_modal_eliminar_respuesta(riesgo_id, respuesta_id, respuesta_nombre) {            
    document.getElementById("contenido_modal_eliminar_respuesta").innerHTML = "¿Estas seguro que desea eliminar la siguiente accion del riesgo?";
    document.getElementById("nombre_rta_me").innerHTML = " "+respuesta_nombre;
    document.getElementById("riesgo_id_eliminar").value = riesgo_id;        
    document.getElementById("respuesta_id_eliminar").value = respuesta_id;
    $("#modal_eliminar_respuesta").modal('show');   
  };

  
</script>
<script type="text/javascript">
  //////////////////////////////////////
  // Funciones que capturan los forms
  /////////////////////////////////////
  $(function() { //shorthand document.ready function
    $('#nuevo_riesgo').on('submit', function(e) { //use on if jQuery 1.7+
        e.preventDefault();  //prevent form from submitting
        var riesgo_content = $("#nuevo_riesgo :input").serializeArray();
        console.log(riesgo_content);
       $.ajax({
          type: 'POST',
          url: "{% url 'insertar_riesgo_proyecto' %}",    
          headers: {'X-CSRFToken': csrftoken},      
          data: riesgo_content,
          success: function(data, status, xhr) {
            //alert("Asignados correctamente");
            location.reload();
             console.log(xhr);
          },
          error: function(jqXhr, textStatus, errorMessage) {
            alert("ha ocurrido un error");
            location.reload();
            console.log(errorMessage);
          }
  });
});

  construir_listado_actividades();
  trasnformar_tabla("tabla_riesgos"); 
  
  if(data.length == 0 || contar_subcategorias() == 0){
    body_nuevo_riesgo = document.getElementById('body_nuevo_riesgo');
    body_nuevo_riesgo.innerHTML = ''; 
    let str = '<div class="alert alert-info alert-dismissible"><h4><i class="icon fa fa-info"></i>  Atencion</h4> Hasta el momento usted no cuenta con subcategorias para asignar riesgos<br/>Para definir nuevas subcategorias dale clic <a href="'+"{% url 'mi_rbs'  %}"+'>aqui</a></div>';
      let html = $.parseHTML(str);
      $(body_nuevo_riesgo).append(html);
  }
});



function contar_subcategorias() {
  let cont = 0;
  for (var i = 0; i < data.length; i++) {
    cont += data[i]['subcategorias'].length;
  }
  return cont;
}

function construir_listado_actividades() {
  let div_actividades = document.getElementById("bloq_subcategorias");
  div_actividades.innerHTML = '';
  let select_actividades = document.createElement("select");
  select_actividades.setAttribute("class", "form-control select2");
  select_actividades.setAttribute("id", "actividad_id");
  select_actividades.setAttribute("name", "actividad_id");
  if(actividades.length > 0){
    for (var i = 0; i < actividades.length; i++) {
      let tabs = "";
      let opcion = document.createElement("option");
      opcion.setAttribute("value",actividades[i]["actividad_id"]);
      for (var j = 0; j < actividades[i]["actividad_level"]; j++) {
        opcion.appendChild(document.createTextNode("\u00a0"));
        opcion.appendChild(document.createTextNode("\u00a0"));
      }
      opcion.appendChild(document.createTextNode(actividades[i]["actividad_nombre"]));
      select_actividades.appendChild(opcion);
    }
    div_actividades.appendChild(select_actividades);
  }else{
    div_actividades.innerHTML = '';
    let str = '<div class="alert alert-info alert-dismissible"><h4><i class="icon fa fa-info"></i>  Atencion</h4> Hasta el momento este proyecto no cuenta con actividades del cronograma<br/> Si usted lo desea, puede subir las actividades dando clic <a href="'+"{% url 'mi_proyecto' proyecto.proyecto_id %}"+'">aqui</a></div>';
      let html = $.parseHTML(str);
      $(div_actividades).append(html); 
      let bbb = document.getElementById("btn_agregar_actividad");
      bbb.setAttribute('style',"visibility: hidden;");
  }
}

function construir_listado_actividades_riesgos(riesgo_id) {  
  key = "riesgo_"+riesgo_id;
  let div_actividades = document.getElementById("cuerpo_actividades_riesgos");
  div_actividades.innerHTML ="";

  if(actividades_riesgo.hasOwnProperty(key)){
    let mis_actividades = actividades_riesgo[key];
    for (var i = 0; i < mis_actividades.length; i++) {
      let tr = document.createElement("tr");
      let td_1 = document.createElement("td");
      let td_2 = document.createElement("td");
      td_1.appendChild(document.createTextNode(mis_actividades[i]["actividad_nombre"]));
      let but = document.createElement("button");
      but.setAttribute("type","button");
      but.setAttribute("class","btn btn-danger");
      but.setAttribute("data-toggle","#modal_eliminar");
      but.setAttribute("onclick",
        "abrir_modal_eliminar_actividad("+riesgo_id+",'"+mis_actividades[i]["actividad_id"]+"', '"+mis_actividades[i]["actividad_nombre"]+"');");
      but.setAttribute("data-target","#modal_eliminar");
      let ii = document.createElement("i");    
      ii.setAttribute("class","fa fa-trash-o danger");         
      but.appendChild(ii);
      td_2.appendChild(but);
      tr.appendChild(td_1);
      tr.appendChild(td_2);
      div_actividades.appendChild(tr);
    }


  }else{
    let tr = document.createElement("tr");
    let td_1 = document.createElement("td");
    let td_2 = document.createElement("td");
    td_1.appendChild(document.createTextNode("No cuentas con actividades asociadas a este riesgo."));
    tr.appendChild(td_1);
    tr.appendChild(td_2);
    div_actividades.appendChild(tr);
  }
  
}
function trasnformar_tabla(id_tabla) {
  t = $("#"+id_tabla).DataTable({    
     "language": {
         "sProcessing":    "Procesando...",
         "sLengthMenu":    "Mostrar _MENU_ registros",
         "sZeroRecords":   "No se encontraron resultados",
         "sEmptyTable":    "No cuentas con riesgos asociados a esta subcategoría.",
         "sInfo":          "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
         "sInfoEmpty":     "Mostrando registros del 0 al 0 de un total de 0 registros",
         "sInfoFiltered":  "(filtrado de un total de _MAX_ registros)",
         "sInfoPostFix":   "",
         "sSearch":        "Buscar:",
         "sUrl":           "",
         "sInfoThousands":  ",",
         "sLoadingRecords": "Cargando...",
         "oPaginate": {
             "sFirst":    "Primero",
             "sLast":    "Último",
             "sNext":    "Siguiente",
             "sPrevious": "Anterior"
         },
         "oAria": {
             "sSortAscending":  ": Activar para ordenar la columna de manera ascendente",
             "sSortDescending": ": Activar para ordenar la columna de manera descendente"
         }
     }
    }); 
    t.on( 'order.dt search.dt', function () {
          t.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
              cell.innerHTML = i+1;
          } );
      } ).draw(); 
}

  function parsear_fecha(now){    
    var day = ("0" + now.getDate()).slice(-2);
    var month = ("0" + (now.getMonth() + 1)).slice(-2);
    var today = now.getFullYear()+"-"+(month)+"-"+(day) ;
    return today;
  }

</script>
{% endblock %}